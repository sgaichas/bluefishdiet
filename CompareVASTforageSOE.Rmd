---
title: "Compare VAST and survey planktivores"
author: "Sarah Gaichas"
date: "2022-12-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
```


Compare SOE aggregate survey bio indices to VAST forage index. Caveats: may not contain same species, wont be on same scale

## Compare indices scaled to mean for each EPU

Use Kim B's code to extract planktivores from `ecodata::aggregate_biomass`, modify code to calculate time series sd, rescale

```{r SOEplanktivores}
planktivores <- ecodata::aggregate_biomass %>%
  dplyr::filter(Var %in% c("Planktivore Fall Biomass Index",
                           "Planktivore Spring Biomass Index",
                           "Planktivore Fall Biomass Standard Error",
                           "Planktivore Spring Biomass Standard Error"))%>%
  tidyr::separate(Var, c("feeding.guild", "season", "Biomass", "Var1", "Null", "Area"), sep = " ") %>%
  tidyr::unite("Var", feeding.guild:season, sep = " ") %>%
  dplyr::mutate(stat = recode(Var1, Index = "Mean",
                      Standard = "SD")) %>%
  dplyr::select(-Biomass, -Var1, -Null, -Units) %>%
  # dplyr::filter(!Area == "-") %>%
  dplyr::group_by(Var, Time, EPU, Area) %>%
  tidyr::pivot_wider(id_cols = c(Var, Time, EPU, Area),names_from =  stat, values_from =  Value) %>%
  dplyr::filter(!Mean == "NULL") %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Mean = as.numeric(Mean))


agg_bio<-planktivores %>% dplyr::filter(EPU %in% c("MAB", "GB", "GOM"),
         Time >= 1968) %>%
  dplyr::group_by(Var, EPU) %>%
  dplyr::mutate(hline = mean(Mean, na.rm = T), 
                tssd = sd(SD, na.rm = T),
                 upper = Mean + (2*SD),
                lower = Mean - (2*SD)) %>%
  dplyr::ungroup()  

agg_bio_std <- agg_bio %>%
  dplyr::mutate(stdPlank = (Mean-hline)/tssd,
                #cv = SD/Mean,
                stdPlankupper = (upper-hline)/tssd,
                stdPlanklower = (lower-hline)/tssd)

agg_bio_std$Var <- factor(agg_bio_std$Var,levels = c("Planktivore Spring",
                                                    "Planktivore Fall"))
series.col <- rep("black",length(unique(agg_bio_std$Var)))
facet_names <- list("Planktivores" = expression("Planktivores")
                    )

```

### Test plotting

Original SOE plot scale

```{r SOEplot}
#Time series constants
shade.alpha <- 0.3
shade.fill <- "lightgrey"
lwd <- 1
pcex <- 2
trend.alpha <- 0.5
trend.size <- 2
hline.size <- 1
hline.alpha <- 0.35
hline.lty <- "dashed"
label.size <- 5
hjust.label <- 1.5
letter_size <- 4
feeding.guilds <- c("Apex Predator","Piscivore","Planktivore","Benthivore","Benthos")
x.shade.min <- 2011
x.shade.max <- 2021
series.col <- c("indianred","black")
#Function for custom ggplot facet labels
label <- function(variable,value){
  return(facet_names[value])
}

p3<-agg_bio_std %>%
  dplyr::filter(str_detect(Var,"Planktivore")) %>%
  ggplot2::ggplot() +

  #Highlight last ten years
  #ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
  #    xmin = x.shade.min , xmax = x.shade.max ,
  #    ymin = -Inf, ymax = Inf) +
  #Test for trend and add lines
  ecodata::geom_gls(aes(x = Time, y = Mean,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  ecodata::geom_lm(aes(x = Time, y = Mean,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  # #ecodata::geom_lm(aes(x = Time, y = Mean))+

  #Add time series
  ggplot2::geom_ribbon(aes(x = Time, ymin = pmax(lower,0), ymax = upper),
              alpha = 0.5,
              fill = "grey") +
  ggplot2::geom_line(aes(x = Time, y = Mean),size = lwd-0.5) +
  ggplot2::geom_point(aes(x = Time, y = Mean),size = pcex-0.5) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+
  ggplot2::facet_wrap(EPU ~ Var~.,ncol = 2, scales = "free_y") +
       #Add NEAMAP
  # ggplot2::geom_ribbon(data = neamap.3, aes(ymax = pmax(upper, 0), ymin = lower, x = Time),
  #               fill = "pink", alpha = 0.5) +
  # ggplot2::geom_line(data = neamap.3, aes(x = Time, y = Value),
  #           color = "#ca0020")+
  # ggplot2::geom_point(data = neamap.3, aes(x = Time, y = Value),
  #            size = pcex-0.5,
  #            color = "#ca0020")+

  #Axis and theme
  ggplot2::scale_x_continuous(breaks = seq(1970, 2020, by = 10), expand = c(0.01, 0.01)) +
  #ylim(0, 600)+
  ggplot2::ylab(expression("Biomass (kg tow"^-1*")")) +
  ecodata::theme_facet()+
  ggplot2::theme(strip.text=element_text(hjust=0),
        axis.title.x=element_blank())

p3


```

Rescaled SOE plots

```{r rescaleSOEplot}


p4<-agg_bio_std %>%
  dplyr::filter(str_detect(Var,"Planktivore")) %>%
  ggplot2::ggplot() +

  #Highlight last ten years
  #ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
  #    xmin = x.shade.min , xmax = x.shade.max ,
  #    ymin = -Inf, ymax = Inf) +
  #Test for trend and add lines
  ecodata::geom_gls(aes(x = Time, y = stdPlank,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  ecodata::geom_lm(aes(x = Time, y = stdPlank,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  # #ecodata::geom_lm(aes(x = Time, y = Mean))+

  #Add time series
  ggplot2::geom_ribbon(aes(x = Time, ymin = pmax(stdPlanklower,0), ymax = stdPlankupper),
              alpha = 0.5,
              fill = "grey") +
  ggplot2::geom_line(aes(x = Time, y = stdPlank),size = lwd-0.5) +
  ggplot2::geom_point(aes(x = Time, y = stdPlank),size = pcex-0.5) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::geom_hline(aes(yintercept = 0,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+
  ggplot2::facet_wrap(EPU ~ Var~.,ncol = 2, scales = "free_y") +
       #Add NEAMAP
  # ggplot2::geom_ribbon(data = neamap.3, aes(ymax = pmax(upper, 0), ymin = lower, x = Time),
  #               fill = "pink", alpha = 0.5) +
  # ggplot2::geom_line(data = neamap.3, aes(x = Time, y = Value),
  #           color = "#ca0020")+
  # ggplot2::geom_point(data = neamap.3, aes(x = Time, y = Value),
  #            size = pcex-0.5,
  #            color = "#ca0020")+

  #Axis and theme
  ggplot2::scale_x_continuous(breaks = seq(1970, 2020, by = 10), expand = c(0.01, 0.01)) +
  #ylim(0, 600)+
  ggplot2::ylab(expression("Biomass (kg tow"^-1*")")) +
  ecodata::theme_facet()+
  ggplot2::theme(strip.text=element_text(hjust=0),
        axis.title.x=element_blank())

p4


```

Rescale forage indices and add to rescaled SOE plot

```{r VASTrescaleSOE}

ecodata::forage_index %>%
  dplyr::filter(Var %in% c("Annual Forage Fish Biomass Estimate",
                           "Annual Forage Fish Biomass Estimate SE",
                           "Fall Forage Fish Biomass Estimate",
                           "Fall Forage Fish Biomass Estimate SE",
                           "Spring Forage Fish Biomass Estimate",
                           "Spring Forage Fish Biomass Estimate SE"))%>%
  tidyr::separate(Var, c("season", "feeding.guild", "Null","Biomass", "Null", "SE"), sep = " ") %>% #here
  tidyr::unite("Var", feeding.guild:season, sep = " ") %>%
  dplyr::mutate(stat = recode(Var1, Index = "Mean",
                      Standard = "SD")) %>%
  dplyr::select(-Biomass, -Var1, -Null, -Units) %>%
  # dplyr::filter(!Area == "-") %>%
  dplyr::group_by(Var, Time, EPU, Area) %>%
  tidyr::pivot_wider(id_cols = c(Var, Time, EPU, Area),names_from =  stat, values_from =  Value) %>%
  dplyr::filter(!Mean == "NULL") %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Mean = as.numeric(Mean))

```

## Compare species lists