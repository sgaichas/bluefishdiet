---
title: Assessing small pelagic fish trends in space and time using piscivore diet data
author: "Sarah Gaichas, James Gartland, Brian Smith, Elizabeth Ng, Michael Celestino,
  Anthony Wood, Katie Drew, Abigail Tyrell, and James Thorson"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2: 
    toc: true
    toc_float: true
  bookdown::word_document2:
    toc: false
  bookdown::pdf_document2:
    includes: 
       in_header: latex/header1.tex
    keep_tex: true
link-citations: yes
csl: "canadian-journal-of-fisheries-and-aquatic-sciences.csl"
bibliography: FishDiet_EcoIndicators.bib
---

```{r setup, include=FALSE}

# https://cdnsciencepub.com/journal/cjfas/authors#guidelines
# Manuscript text must: 
# 
# be in English or French
# be double-spaced
# be single-column
# include page numbers
# include continuous line numbers (before acceptance only)
# be 8.5 x 11 inches in page size (or ISO A4)
# follow this order: title page, abstract, keywords, body text (Introduction, Materials and methods, Results, Discussion), acknowledgements, references, tables, figure captions, figures, appendices
# do the above formatting *after* coauthors edit a word-->gdoc version

knitr::opts_chunk$set(echo = FALSE, # no code blocks in word doc
                      message = FALSE,
                      warning = FALSE)

library(tidyverse)
theme_set(theme_bw())
library(here)
library(dendextend)
library(flextable) #hopefully makes actual tables in word
set_flextable_defaults(font.size = 11, padding = 3,
                       fonts_ignore=TRUE) #for latex
#library(DT)
#library(pdftools)
#library(patchwork)
library(ggiraph)
library(ggpubr)
library(data.table)
library(forcats)

#library(ecodata)
#library(VAST)

# try to put affiliations in the yaml header later
# author:
# - affiliation: group1
#   name: 'Sarah Gaichas, Brian Smith, Anthony Wood, Abigail Tyrell'
# - affiliation: group2
#   name: James Gartland
# - affiliation: group3
#   name: Elizabeth Ng
# - affiliation: group4
#   name: Michael Celestino
# - affiliation: group5
#   name: Katie Drew
# - affiliation: group6
#   name: Abigail Tyrell
# address:
# - address: NOAA NMFS Northeast Fisheries Science Center, Woods Hole, MA, USA
#   code: group1
# - address: Virginia Institute of Marine Science, Gloucester Point, VA, USA
#   code: group2
# - address: University of Washington, Seattle, WA, USA
#   code: group3
# - address: New Jersey Department of Environmental Protection, Port Republic, NJ, USA
#   code: group4
# - address: Atlantic States Marine Fisheries Commission, Arlington, VA, USA
#   code: group5
# - address: Ocean Associates Inc, Arlington, VA, USA
#   code: group6

```

  
# Abstract {-}

Changing distribution and abundance of small pelagics may drive changes in predator distributions, affecting predator availability to fisheries and surveys. However, small pelagic fish are difficult to survey directly, so we developed a novel method of assessing small pelagic fish aggregate abundance via predator diet data. We used piscivore diet data collected from multiple bottom trawl surveys within a Vector Autoregressive Spatio-Temporal (VAST) model to assess trends of small pelagics on the Northeast US shelf. The goal was to develop a spatial “forage index” to inform survey and/or fishery availability in the bluefish (*Pomatomus saltatrix*) stock assessment. Using spring and fall surveys from 1973-2021, 20 small pelagic groups were identified as major bluefish prey using the diet data. Then, predators were grouped by diet similarity to identify 21 piscivore species with the most similar diet to bluefish in the region. Diets from all 22 piscivores were combined for the 20 prey groups at each surveyed location, and the total weight of small pelagic prey per predator stomach at each location was input into a Poisson-link delta model to estimate expected prey mass per predator stomach. Best fit models included spatial and spatio-temporal random effects, with predator mean length, number of predator species, and sea surface temperature as catchability covariates. Spring and fall prey indices were split into inshore and offshore areas to reflect changing prey availability over time in areas available to the recreational fishery and the bottom trawl survey, and also to contribute to regional ecosystem reporting. Diet-based forage indices were compared with survey design-based biomass estimates for the same small pelagic groups. The diet-based forage index included more small, unmanaged forage species than direct trawl survey sampling, providing the best insight into trends for these species. Overall, the diet-based forage index shows promise as a covariate for bluefish availability to the recreational fishery.

# Introduction

[Paragraph about ecosystem influences on stocks including predators following prey]

[Background on the bloodthirsty bluefish following schools of small pelagic prey and stakeholder observations of prey-driven availability]

[Paragraph about incomplete sampling of small pelagics by bottom trawl surveys]

The objective of this work was to create a "prey index" to evaluate changes in bluefish prey over time and in space using Vector Autoregressive Spatio-Temporal modeling (VAST [@thorson_comparing_2017; @thorson_guidance_2019]). This approach was patterned on @ng_predator_2021, which used predator stomach data to create a biomass index for a single prey, Atlantic herring. Expected biomass of herring per stomach was estimated in VAST with 2 linear predictors, the number of herring per stomach and the average weight of herring in a stomach. We adapted the approach of @ng_predator_2021 to get an index for "bluefish prey" in aggregate rather than a single prey species. Further, we include inshore and offshore regions by combining results across regional bottom trawl surveys surveys as was done for summer flounder biomass in @perretti_spatio-temporal_2019. Finally, since bluefish themselves are somewhat sparsely sampled by the surveys, we aggregate all predators that have a similar diet composition to bluefish to better represent bluefish prey biomass. This approach is generalizable to any spatial subset of the full VAST spatial domain, such that forage indices for each ecoregion on the Northeast US continental shelf, or for other piscivore predators can also be generated. 

# Methods

We characterize mean weight of bluefish prey from all piscivores caught at each survey location and model that over time/space. Covariates potentially affecting perceived patterns in the bluefish prey index include number of predators, size composition of predators, and sea surface temperature (SST) at each survey location. 

Therefore, the steps involved to estimate the forage index included defining the input dataset, and running multiple configurations of the VAST model. Steps involved in defining the dataset included defining "bluefish prey", defining a set of piscivore predators with similar diets to bluefish, integrating diet data from two regional surveys, and integrating supplementary SST data to fill gaps in in-situ temperature data measurements. Steps involved in running the VAST model included decisions on spatial footprint, model structure, model selection to determine if spatial and spatio-temporal random effects were supported by the data, and further model selection to determine which catchability covariates were best supported by the data. We compared the resulting diet based prey index to survey design based biomass estimates for the same group of species at broad regional and seasonal scales to gain insight into the differences between the approaches. Finally, subsets of the spatial domain were defined to match bluefish assessment inputs (survey and recreational fishery CPUE) for potential use as covariates in bluefish stock assessment models, and a bias-corrected [@thorson_implementing_2016] forage index for each spatial subset was generated. Each step is detailed below.

## Input dataset
Fish food habits data are collected aboard several regional fishery independent surveys in the Northeast US. The longest time series of diet has been collected by the Northeast Fisheries Science Center (NEFSC) bottom trawl survey [@smith_trophic_2010] from south of Cape Hatteras, NC to the Scotian Shelf at the US/Canada border since the early 1970s, which represents the bulk of the data for this analysis. Using similar survey protocols to the NEFSC survey, the NorthEast Area Monitoring and Assessment Program (NEAMAP) survey has collected fish diet data in inshore waters from Cape Hatteras, NC to Cape Cod, MA since 2008 [@northeast_area_monitoring__assessment_program_neamap_monitoring_2021]. All analyses were completed in R [@r_core_team_r_2021].

### Defining bluefish prey  
Bluefish eat small pelagics that are not well sampled by bottom trawl surveys. Bluefish themselves are not well sampled by bottom trawl surveys. Nevertheless, the diet samples collected for bluefish indicate that anchovies, herrings, squids, butterfish, scup, and small hakes are important prey. See the Bluefish Ecosystem Socioeconomic Profile working paper, as well as [this web summary page link](https://sgaichas.github.io/bluefishdiet/DietSummary.html) for NEFSC survey and [this presentation link](https://docs.google.com/presentation/d/1VlP0OsSLnoaoFHHt7kJbrqNTgBJqI6Ru/edit#slide=id.p1) for NEAMAP survey bluefish diet composition summaries.

Using all sampled bluefish stomachs included in the NEFSC food habits database 1973-2021, we created a list of all pelagic nekton bluefish prey that had at least 10 observations (Table \@ref(tab:preylist)). Broad categories such as empty stomach, fish unidentified, Osteichthyes, unidentified animal remains, and blown stomach were not included in the prey list.

```{r preylist}
# object is called `allfh`
#load(url("https://github.com/Laurels1/Condition/raw/master/data/allfh.RData"))

# Oct 21 2022: save it for posterity, use in case Laurel's repo updates
#save(allfh, file = "fhdat/allfh.Rdata")
load(here("fhdat/allfh.Rdata"))

# October 8 2022: add NEFSC 2021 data
load(here("fhdat/allfh21.Rdata"))

allfh <- allfh %>%
  dplyr::bind_rows(allfh21)

preycount <- allfh %>%
   group_by(pdcomnam, pynam) %>%
   summarise(count = n()) %>%
   filter(pdcomnam != "") %>%
   #arrange(desc(count))
   pivot_wider(names_from = pdcomnam, values_from = count) 

gencomlist <- allfh %>%  
  select(pynam, pycomnam2, gencom2) %>%
  distinct()

blueprey <- preycount %>%
  filter(BLUEFISH > 9) %>%
  filter(!pynam %in% c("EMPTY", "BLOWN",
                       "FISH", "OSTEICHTHYES",
                       "ANIMAL REMAINS",
                       "FISH SCALES")) %>%
  #filter(!str_detect(pynam, "SHRIMP|CRAB")) %>%
  left_join(gencomlist) %>%
  filter(!gencom2 %in% c("ARTHROPODA", "ANNELIDA",
                         "CNIDARIA", "UROCHORDATA",
                         "ECHINODERMATA", "WORMS",
                         "BRACHIOPODA", "COMB JELLIES",
                         "BRYOZOA", "SPONGES",
                         "MISCELLANEOUS", "OTHER")) %>%
  arrange(desc(BLUEFISH))

# kableExtra::kable(blueprey[,c('pynam','BLUEFISH')],
#                   col.names = c('Prey name', 'Bluefish stomachs (n)'),
#                   caption = "Table 1. Prey identified in bluefish stomachs, NEFSC diet database, 1973-2020.")

flextable::flextable(blueprey[,c('pynam', 'pycomnam2','BLUEFISH')]) %>%
  flextable::set_header_labels(pynam = "Prey name", pycomnam2 = "Prey common name", BLUEFISH = "Bluefish stomachs (n)") %>%
  flextable::set_caption("Prey identified in bluefish stomachs, NEFSC diet database, 1973-2021.") %>%
  #flextable::autofit()
  flextable::width(width = c(2.5,3.5,0.5))
```


### Defining piscivore predators  
The choice of predators is largely intended to balance increasing sample size for modeling bluefish prey with using predators likely to be foraging similarly to bluefish.  One extreme assumption would be to include only bluefish as predators, but there are relatively few bluefish diet samples due to incomplete availability to bottom trawl surveys (see supplemental information). This would miss prey available to bluefish because we have not sampled bluefish adequately. The opposite extreme assumption would be to include all stomachs that contain any of the top bluefish prey, regardless of which species ate the prey. This would include predators that do not forage similarly to bluefish and might therefore "count" prey that are not actually available to bluefish due to habitat differences. The intermediate approach which selects a group of piscivores that forage similarly to bluefish both increases sample size and screens out the most dissimilar predators to bluefish. A further refinement to the input data is only using the prey items identified above as "bluefish prey" across all predators identified as piscivores.

For bluefish forage index modeling, we are selecting a set of predators that have high diet similarity to bluefish. @garrison_dietary_2000 evaluated similarity of predator diets on the Northeast US shelf to develop foraging guilds. The Schoener similarity index [@schoener_nonsynchronous_1970] was applied

>to assess the dietary overlap, $D_{ij}$, between predator pairs:

$$ D_{i,j} = 1 – 0.5 (\sum |p_{i,k} – p_{j,k}|) $$

>where $p_{i,k}$ = mean proportional volume of prey type $k$ in predator $i$ and $p_{i,k}$ = mean proportional volume of
prey type $k$ in predator $j$ [@garrison_dietary_2000]. 

@garrison_dietary_2000 used NEFSC bottom trawl survey data 1973-1997. We are using diets from 1985-2020 to characterize the forage index. Therefore an additional 20+ years of diet information is available to assess whether predator diet similarity has changed. Diet similarity analysis has been completed (B. Smith, pers. comm.), with a table of prey similarity available via [this link on the NEFSC food habits shiny app](https://fwdp.shinyapps.io/tm2020/#4_DIET_OVERLAP_AND_TROPHIC_GUILDS) that was used to define feeding guilds based on 50 predators. We evaluated results from several clustering algorithms (see [this link](https://sgaichas.github.io/bluefishdiet/PreySimilarityUpdate.html)) to determine how robustly different sets of predators grouped with bluefish. The working group selected the piscivore list based on the "complete" clustering algorithm, including all species that clustered with all 3 sizes of bluefish (Table \@ref(tab:pisclist)). 

```{r pisclist}
dietoverlap <- read_csv(here("datfromshiny/tgmat.2022-02-15.csv"))

d_dietoverlap <- dist(dietoverlap)

# again directly from https://cran.r-project.org/web/packages/dendextend/vignettes/Cluster_Analysis.html
hclust_methods <- c("ward.D", "single", "complete", "average", "mcquitty", 
        "median", "centroid", "ward.D2")
diet_dendlist <- dendlist()
for(i in seq_along(hclust_methods)) {
   hc_diet <- hclust(d_dietoverlap, method = hclust_methods[i])   
   diet_dendlist <- dendlist(diet_dendlist, as.dendrogram(hc_diet))
}
names(diet_dendlist) <- hclust_methods

# preds <- list()
# 
# for(i in 1:8) {
#   dendi <- diet_dendlist[[i]]
#   namei <- names(diet_dendlist)[i]
#   labels(dendi) <- paste(as.character(names(dietoverlap[-1]))[order.dendrogram(dendi)],
#                            "(",labels(dendi),")", 
#                            sep = "")
#   #preds[[namei]] <- partition_leaves(dendi)[[which_node(dendi, c("35", "36", "37"))]]
#   preds[[namei]] <- partition_leaves(dendi)[[which_node(dendi, c("Bluefish..S(37)", "Bluefish..M(36)", "Bluefish..L(35)"))]]
# 
# }

dendi <- diet_dendlist$complete

labels(dendi) <- paste(as.character(names(dietoverlap[-1]))[order.dendrogram(dendi)],
                           "(",labels(dendi),")", 
                           sep = "")
  
pisccomplete <- partition_leaves(dendi)[[which_node(dendi, c("Bluefish..S(37)", "Bluefish..M(36)", "Bluefish..L(35)"))]]
  

sizedefs <- allfh %>% 
  select(pdcomnam, sizecat, pdlen) %>% 
  group_by(pdcomnam, sizecat) %>% 
  summarize(minlen = min(pdlen), maxlen = max(pdlen))

pisccompletedf <- data.frame("COMNAME" = toupper(str_remove(pisccomplete, "\\..*")),
                              "SizeCat" = str_remove(str_extract(pisccomplete, "\\..*[:upper:]+"), "\\.."),
                              "feedguild" = "pisccomplete") %>%
  left_join(sizedefs, by=c("COMNAME" = "pdcomnam", 
                          "SizeCat" = "sizecat")) %>%
  arrange(COMNAME, minlen)

  
# kableExtra::kable(pisccompletedf[,-3],
#                   col.names = c('Predator name', "Size category", "Minimum length (cm)", "Maximum length (cm)"),
#                   caption = "Table 2. Predators with highest diet similarity to Bluefish, NEFSC diet database, 1973-2020.",
#                   align = "rccc")  

flextable::flextable(pisccompletedf[,-3]) %>%
  flextable::set_header_labels(COMNAME = 'Predator name', 
                               SizeCat = "Size category", 
                               minlen = "Minimum length (cm)",
                               maxlen = "Maximum length (cm)") %>%
  flextable::set_caption("Predators with highest diet similarity to Bluefish, NEFSC diet database, 1973-2020.") %>%
  #flextable::autofit()
  flextable::width(width = c(3, 1, 1, 1))
  
```

```{r circulardend, eval=FALSE}

guilds <- hclust(d_dietoverlap)

dend <- as.dendrogram(guilds)

dend <- rotate(dend, 1:136)

dend <- color_branches(dend, k=6)

dend <- color_labels(dend, k=6)

labels(dend) <- paste(as.character(names(dietoverlap[-1]))[order.dendrogram(dend)],
                           "(",labels(dend),")", 
                           sep = "")

dend <- hang.dendrogram(dend,hang_height=0.1)

# reduce the size of the labels:
# dend <- assign_values_to_leaves_nodePar(dend, 0.5, "lab.cex")
dend <- set(dend, "labels_cex", 0.75)
# And plot:
# par(mar = c(3,3,3,7))
# plot(dend, 
#      main = "Clustered NEFSC diet data, (complete)
#      (the labels give the predator species/size)", 
#      horiz =  TRUE,  nodePar = list(cex = .007))

circlize::circos.par(start.degree = 90)
par(mar = rep(0,4))
circlize_dendrogram(dend,
                    labels_track_height=0.3,
                    dend_track_height = 0.6)

```


This piscivore dataset better captured predators that feed similarly to bluefish (e.g. striped bass), and has a higher proportion of stations with bluefish prey than a dataset based on the @garrison_dietary_2000 piscivore definition. We also evaluated a piscivore definition using only the predators that always cluster with bluefish no matter what clustering algorithm is applied. However, a dataset based on that limited piscivore list excluded predators highlighted by bluefish experts (e.g., striped bass) and resulted in the inclusion of fewer overall stations than the either of the above piscivore definitions, with a lower proportion of included stations with bluefish prey.

The NEAMAP survey operates closer to shore than the current NEFSC survey. While both surveys capture many of the same predators, some are not available close to shore and others are more available close to shore. The NEAMAP dataset includes the following piscivore predators and size ranges, adding two species not captured by the NEFSC survey offshore but included based on working group expert judgement of prey similarity to bluefish (Spanish mackerel and spotted sea trout) and leaving out those not captured inshore:

+  Summer Flounder 21-70 cm
+  Silver Hake 21-76 cm
+  Weakfish 26-50 cm
+  Atlantic Cod 81-150 cm 
+  Bluefish 3 – 118 cm
+  Striped Bass 31 – 120 cm
+  Spanish Mackerel 10 – 33.5 cm 
+  Spotted Sea Trout 15.5 – 34 cm 
+  Spiny Dogfish 36 – 117 cm
+  Goosefish 5 – 124 cm  

### Integrating regional surveys  
For each survey dataset, the full diet database was filtered to include only predators on the list of piscivores with the most diet similarity to bluefish (Table \@ref(tab:pisclist)). Then, the list of bluefish prey (Table \@ref(tab:preylist)) was used to categorize prey items for each predator as "bluefish prey" or "other prey". Each station was given a unique station identifier (cruise and station number), and the total weight (g) of bluefish prey at each station was summed. Total bluefish prey weight was divided by the total number of stomachs across all piscivore predators at the station to get mean bluefish prey weight (g) at each station. In addition, the number of piscivore species and the mean size (total length, cm) across all piscivores was calculated at each station. Seasons were identified as "Spring" (collection months January - June) and "Fall" (collection months July-December) to align with assumptions used in the bluefish stock assessment. Vessel identifiers were assigned based on years and survey, with two vessels used for the NEFSC survey (R/V Albatross prior to 2009 and R/V Bigelow 2009 to present) and a single vessel used for the NEAMAP survey 2008-present. These were used to evaluate whether vessel effects were present. Variable names were reconciled between NEFSC and NEAMAP, and the datasets were appended into a single dataset with one row per station including station ID, year, season, date, latitude, longitude, vessel, mean bluefish prey weight, mean piscivore length, number of piscivore species, and sea surface temperature (degrees C).  

### Filling gaps in sea surface temperature (SST) data  
Initial dataset checks revealed that approximately 10% of survey stations were missing in-situ sea water temperature measurements. Gaps in temperature information were more prevalent early in the time series (1980s and early 1990s), although stations without temperature data were found in nearly all years (see "SST mismatch by year" section [at this link](https://sgaichas.github.io/bluefishdiet/SSTmethods.html)). Rather than truncate the dataset to only those stations with in-situ temperature measurements, we investigated other sources of SST data to fill gaps.

Two SST data sources were investigated, both based on satellite data: the National Oceanic and Atmospheric Administration Optimum Interpolation Sea Surface Temperature (NOAA OI SST) V2 High Resolution Dataset [@reynolds_daily_2007] data provided by the NOAA PSL, Boulder, Colorado, USA, from their website at https://psl.noaa.gov, and the higher resolution source data for the OI SST, the [AVHRR Pathfinder SST data linked here](https://www.ncei.noaa.gov/products/avhrr-pathfinder-sst) [@saha_avhrr_2018]. Both sources provide global daily SST at different spatial resolutions (OI SST uses a 25 km grid, and AVHRR uses a 4 km grid) from 1981-present. 

The OI SST data are provided as global files for each year. Files for years 1985-2021 were downloaded from https://downloads.psl.noaa.gov/Datasets/noaa.oisst.v2.highres/sst.day.mean.[year].v2.nc as rasters using code developed by Kim Bastille for Northeast US ecosystem reporting, cropped to the Northeast US spatial extent, and converted to R dataframe objects where the temperature of a grid cell is associated with the coordinates at the center of the grid cell. Then, OI SST temperature was matched to the survey data using year, month, day and spatial nearest neighbor matches to survey station locations. 

AVHRR data is organized into year/data folders with 2 nc files for each date, one day and one night. A list of survey year-month-day combinations was generated from the piscivore diet dataset to download only AVHRR daily files within $\pm$ 2 days of survey dates from https://www.ncei.noaa.gov/data/oceans/pathfinder/Version5.3/L3C/[year]/data/. The "sea_surface_temperature" and "quality_level" fields were extracted as rasters, cropped to the Northeast US spatial extent, appended into an annual dataset and saved as R dataframe objects similar to the OI SST methods. Examination of a subset of AVHRR SST data with quality level 3 and above showed extended periods with little SST data within the survey domain, likely due to cloud cover (see "SST AVHRR 2021 survey dates" section [at this link](https://sgaichas.github.io/bluefishdiet/SSTmethods.html)). Therefore, to match AVHRR SST to survey stations, methods for combining and filling temporal and spatial gaps would be required, which was beyond the scope of the current analysis. 

For survey stations with in-situ temperature measurements, the in-situ measurement was retained. For survey stations with missing temperature data (~10% of all stations), OI SST was substituted for input into VAST models.

## VAST modeling  
We used VAST [@thorson_comparing_2017; @thorson_guidance_2019] to evaluate changes in bluefish prey biomass and distribution over time. VAST is structured to estimate fixed and random effects across two linear predictors, which are then multiplied to estimate an index of the quantity of interest. Using notation from @thorson_guidance_2019, a full model for the first linear predictor $\rho_1$ for each observation ($i$) can include fixed intercepts ($\beta$) for each category ($c$) and time ($t$), spatial random effects ($\omega$) for each location ($s$) and category, spatio-temporal random effects ($\varepsilon$) for each location, category, and time, fixed vessel effects ($\eta$) by vessel ($v$) and category, and fixed catchability impacts ($\lambda$) of covariates ($Q$) for each observation and variable ($k$): 

$$ \rho_1(i) = \beta_1(c_i, t_i) + \omega_1^*(s_i, c_i) + \varepsilon_1^*(s_i, c_i, t_i) + \eta_1(v_i, c_i) + \sum_{k=1}^{n_k} \lambda_1(k) Q(i,k)$$

The full model for the second linear predictor $\rho_2$ has the same structure, estimating $\beta_2$, $\omega_2$, $\varepsilon_2$, $\eta_2$, and $\lambda_2$ using the observations, categories, locations, times, and covariates.  VAST models can also include habitat (density) covariates, which we did not implement here, and have left out of the equation for simplicity.

### Structural decisions  
@thorson_guidance_2019 lists 15 major decisions for constructing a VAST model. These include decisions on spatial domain, categories modeled (species, ages, etc), data type (presence absence, number, weight), including spatial and or spatio-temporal variation, spatial resolution, univariate vs multivariate response and factors, specifying temporal correlation, including density and or catchability covariates, treatment of area swept calculation, including vessel effects, selecting a link function, specifying derived quantities, bias correcting derived quantities, and model selection. Here we outline the decisions made in developing the forage index.

#### Spatial domain
Models were run using the full Northwest Atlantic grid built into VAST (Fig. \@ref(fig:nwagrid)). Specific strata sets were used from this full model to develop indices matching the spatial extent of different assessment inputs (see below). 

```{r nwagrid, fig.cap="Northwest Atlantic Grid (blue outline) from https://github.com/James-Thorson-NOAA/FishStatsUtils"}
ggplot(data = ecodata::coast) +
  geom_sf() + 
  geom_point(data = FishStatsUtils::northwest_atlantic_grid, aes(x = Lon, y = Lat), colour = "blue", size=0.05, alpha=0.1) +
  #geom_point(data = coast3nmbuff, aes(x = Lon, y = Lat), size=0.05, colour = "green",  alpha=0.1) +
  coord_sf(xlim = c(-79, -65.5), ylim = c(33, 45))+
  ggtitle("Northwest Atlantic Grid")
```

#### Categories, data type, and link function
We model all bluefish prey in aggregate as a single category. The mean weight of bluefish prey in a stomach at each location is treated as biomass data in the model. Therefore, VAST applies a delta model where the first linear predictor models encounter rate and the second linear predictor models amount of prey (equivalent to positive catch rates on a survey). Following what @ng_predator_2021 did for herring, as well as recommended practice for biomass data [@thorson_guidance_2019], we apply a Poisson-link delta model to estimate expected prey mass per predator stomach.

#### Spatial variation, resolution, response type, and temporal correlation
We include spatial and spatio-temporal variation in both linear predictors, but test whether the data support these effects using model selection (see below). Similar to @ng_predator_2021 we used the default spatial smoother in VAST, the stochastic partial differential equation (SPDE) approximation to the Mat\'ern correlation function (method = "mesh"; @thorson_guidance_2019). Although directional correlation (anisotopy) can be common in fishery collections with depth gradients along a continental shelf [@thorson_guidance_2019], we tested whether the inclusion of anisotopy as a fixed effect was supported using model selection (see below). We used a higher spatial resolution than @ng_predator_2021 did for herring-predator pairs, here defining 500 "knots" or standardized locations optimally allocated among all observed survey stations in the full dataset as estimated by k-means clustering of the data, to define the spatial dimensions of each seasonal model and the annual model.

Modeling all bluefish prey in aggregate leads to a univariate model, producing a single forage index which is most easily integrated into the bluefish assessment model. We did not include temporal correlation in fixed intercepts to maintain independence of forage abundance in each modeled year [@thorson_guidance_2019]. We did not include temporal correlation in spatio-temporal random effects because most survey areas were sampled each year, so projecting forage "hotspots" between years using temporal correlation was not desirable for this application. 

#### Including covariates, vessel effects, area swept, and other decisions
We explored multiple combinations of catchability covariates and vessel effects. Surveys were conducted aboard multiple vessels over time and between NEFSC and NEAMAP, so we investigated vessel effects for the NEAMAP vessel and NEFSC vessels Albatross and Bigelow (commonly included in regional stock assessments when survey indices are not modeled separately). Vessel effects were modeled as overdispersion parameters.  Catchability covariates explored included mean predator length at each station, number of predator species at each station, and sea surface temperature (SST) at each station. 

The predator length covariate may more directly model vessel differences in predator survey catch that affect stomach contents than modeling a vessel catchability covariate directly. @ng_predator_2021 found that predator length covariates were strongly supported as catchability covariates (larger predators being more likely to have more prey in stomachs). The rationale for including number of predator species is that more species "sampling" the prey field at a particular station may result in a higher encounter rate (more stations with positive bluefish prey in stomachs). Water temperature was also included as a potential catchability covariate, because temperature affects predator feeding rate.

VAST can include habitat or density covariates that are expected to drive modeled species distribution and abundance (as opposed to catchability covariates, which affect our survey observations). For example, a certain habitat or depth may limit the range or productivity of a species. Because we are interested in an aggregate index of forage fish that includes a diversity of species that use many different habitats, including density covariates appropriate across all species (that affect density in the same way) may not be feasible, and was not explored for this project.   

Although the forage fish index is based on trawl-surveyed fish predators and the area swept of the net capturing predators is available, determining the actual area swept of the predators "sampling" the prey field is less clear. Therefore, we set area swept to 1 as recommended for "sampling gears" with unknown effective sampling areas, which means our forage abundance index does not have an interpretable scale, but should be proportional to actual forage biomass [@thorson_guidance_2019]. 

The derived quantity of interest here is a biomass index for each of spring, fall, and annual datasets for bluefish prey species. We have also included supplementary plots of the center of gravity for each seasonal model and the annual model. 

Bias correction of the forage fish biomass index for each model (and spatial subdivisions, see below) is based on @thorson_implementing_2016, as implemented in the VAST development branch code (https://github.com/James-Thorson-NOAA/VAST/tree/dev). 

### Model selection  
We compared the AIC for the 500 knot models to see if including the spatial and spatio-temporal random effects in the first and second linear predictors improved the model fit. Model structures tested include with and without anisotopy (2 fixed parameters), and with and without spatial and spatio-temporal random effects in the second linear predictor or both linear predictors. This follows the model selection process outlined in @ng_predator_2021 using restricted maximum likelihood (REML; @zuur_mixed_2009). 

Following this, we evaluated catchability covariates using AIC to determine which are best supported by the data. We used the structure selected by the REML model selection, then evaluated vessel effects (overdispersion) and a range of potential catchability covariates using maximum likelihood to calculate AIC instead of REML, because the spatial and spatio-temporal random effects are the same across models. 

Our two-step model selection (1: spatial and spatio-temporal random effects, 2: catchability covariates) was completed using the script [`bluefishdiet/VASTunivariate_bfp_modselection.R`](https://github.com/sgaichas/bluefishdiet/blob/main/VASTunivariate_bfp_modselection.R). 

## Spatial definitions  

Our main goal is to determine whether bluefish prey availability has changed in inshore waters where the recreational fishery primarily operates.  Our food habits datasets do not extend into inland waters such as bays and sounds, with the exception of Cape Cod Bay. (In the future we might be able to investigate food habits from ChesMMAP or surveys south of Cape Hatteras.) However, there is data from both historical NEFSC surveys and NEAMAP in state coastal waters (0-3 miles from shore), and offshore across the continental shelf. 

The model has been partitioned into several definitions of "inshore" and "offshore" for the stock assessment inputs. First we define a partition that is the MAB and GB areas only as the GOM is not relevant to the bluefish assessment. This is called MABGB (Fig. \@ref(fig:MABGB)), while the full model is AllEPU. Within this partition,

1.  Survey inshore vs offshore to evaluate availability to the survey index. Strata partitions include:
    + Albatross inshore stations (Fig. \@ref(fig:albin))
    + Bigelow inshore bluefish index stations (Fig. \@ref(fig:bluein))
    + offshore bluefish index stations (considered for addition in 2022, Fig. \@ref(fig:blueoff))
    + offshore non-bluefish stations
    
1.  Recreational fishery inshore vs offshore to evaluate availability to the MRIP CPUE index. Strata partitions include
    + shoreline to 3 miles out (State waters, Fig. \@ref(fig:statewaters))
    + offshore of 3 miles (Federal waters)
    
NEFSC survey strata definitions are built into the VAST `northwest-atlantic` extrapolation grid already. We defined additional new strata to address the recreational inshore-offshore 3 mile boundary. The area within and outside 3 miles of shore was defined using the `sf` R package as a 3 nautical mile (approximated as 5.556 km) buffer from a high resolution coastline from the`rnaturalearth` R package. This buffer was then intersected with the current `FishStatsUtils::northwest_atlantic_grid` built into VAST and saved using code [here](https://github.com/sgaichas/bluefishdiet/blob/main/VASTcovariates_updatedPreds_sst_3mi.Rmd#L49-L94). Then, the new State and Federal waters strata were used to split NEFSC survey strata where applicable, and the new full set of strata were used along with a modified function from `FishStatsUtils::Prepare_NWA_Extrapolation_Data_Fn` to build a custom extrapolation grid for VAST as described in detail [here](https://sgaichas.github.io/bluefishdiet/VASTcovariates_finalmodbiascorrect_3misurvstrat.html). 

All strata were applied in both seasonal and annual models. 

Model output strata of interest for the bluefish assessment are mapped below:

```{r}

# 3nm buffer
coast3nmbuff <- readRDS(here("spatialdat/neus_coast3nmbuff.rds"))

fedwaters <- setdiff(FishStatsUtils::northwest_atlantic_grid, coast3nmbuff)


#current bluefish assessment strata are all Bigelow inshore strata MAB-GB
bfinshore <- c(3020, 3050, 3080, 3110, 3140, 3170, 3200, 3230, 
              3260, 3290, 3320, 3350, 3380, 3410, 3440, 3450, 3460)

bfinshoregrid <-  FishStatsUtils::northwest_atlantic_grid %>%
  filter(stratum_number %in% bfinshore)
  
  
# from Tony's 8 March presentation, minus the inshore in CCBay
bfoffshore <- c(1010, 1730, 1690, 1650, 1050, 1060, 1090, 1100, 1250, 1200, 1190, 1610)

bfoffshoregrid <-  FishStatsUtils::northwest_atlantic_grid %>%
  filter(stratum_number %in% bfoffshore)

#from mskeyrun vignette, EPU based on survey strata, replace built in VAST EPU
#https://noaa-edab.github.io/ms-keyrun/articles/GBSurveySet.html

MAB <- c(1010:1080, 1100:1120, 1600:1750, 3010:3450, 3470, 3500, 3510)
GB  <- c(1090, 1130:1210, 1230, 1250, 3460, 3480, 3490, 3520:3550)
GOM <- c(1220, 1240, 1260:1290, 1360:1400, 3560:3830)

MABgrid <-  FishStatsUtils::northwest_atlantic_grid %>%
  filter(stratum_number %in% c(MAB))

GBgrid <-  FishStatsUtils::northwest_atlantic_grid %>%
  filter(stratum_number %in% c(GB))

GOMgrid <-  FishStatsUtils::northwest_atlantic_grid %>%
  filter(stratum_number %in% c(GOM))


MABGBgrid <-  FishStatsUtils::northwest_atlantic_grid %>%
  filter(stratum_number %in% c(MAB, GB))

albinshoregrid <- MABGBgrid %>%
  filter(stratum_number>2999 & stratum_number<3999) %>% #inshore
  anti_join(bfinshoregrid)

othoffshoregrid <- MABGBgrid %>%
  anti_join(bind_rows(albinshoregrid, bfinshoregrid, bfoffshoregrid))

statewatersgrid <- coast3nmbuff %>%
  inner_join(MABGBgrid)

fedwatersgrid <- fedwaters %>%
  inner_join(MABGBgrid)

```

```{r maps, crop=TRUE, fig.cap="Maps of key areas for Bluefish assessment indices. The full VAST model grid is shown in brown.", fig.show='hold', out.width="33%"}

theme_set(theme_bw())

ggplot(data = ecodata::coast) +
  geom_sf() + 
  geom_point(data = FishStatsUtils::northwest_atlantic_grid, aes(x = Lon, y = Lat),  colour = "coral4", size=0.05, alpha=0.1) +
  geom_point(data = MABgrid, aes(x = Lon, y = Lat), colour = "yellow", size=0.05, alpha=0.1) +
  geom_point(data = GBgrid, aes(x = Lon, y = Lat), colour = "orange", size=0.05, alpha=0.1) +
  geom_point(data = GOMgrid, aes(x = Lon, y = Lat), colour = "red", size=0.05, alpha=0.1) +
  #coord_sf(xlim = c(-79, -65.5), ylim = c(33, 45)) + #full extent of VAST model
  coord_sf(xlim =c(-78, -65.5), ylim = c(35, 45)) + #zoomed to Hatteras and N
  ggtitle("a. MAB (yellow), GB (orange), GOM (red)")


ggplot(data = ecodata::coast) +
  geom_sf() + 
  geom_point(data = FishStatsUtils::northwest_atlantic_grid, aes(x = Lon, y = Lat),  colour = "coral4", size=0.05, alpha=0.1) +
  geom_point(data = MABGBgrid, aes(x = Lon, y = Lat), size=0.05, colour = "green",  alpha=0.1) +
  #geom_point(data = albinshoregrid, aes(x = Lon, y = Lat), size=0.03, colour = "blue") +
  geom_point(data = bfinshoregrid, aes(x = Lon, y = Lat), size=0.05, colour = "blue") +
  #geom_point(data = bfoffshoregrid, aes(x = Lon, y = Lat), size=0.05, colour = "orange",  alpha=0.3) +
  #coord_sf(xlim = c(-79, -65.5), ylim = c(33, 45)) +
  coord_sf(xlim =c(-78, -65.5), ylim = c(35, 45)) +
  ggtitle("b. Bluefish survey (blue) in MABGB (green)")

ggplot(data = ecodata::coast) +
  geom_sf() + 
  geom_point(data = FishStatsUtils::northwest_atlantic_grid, aes(x = Lon, y = Lat),  colour = "coral4", size=0.05, alpha=0.1) +
  geom_point(data = MABGBgrid, aes(x = Lon, y = Lat), size=0.05, colour = "green",  alpha=0.1) +
  geom_point(data = statewatersgrid, aes(x = Lon, y = Lat), size=0.03, colour = "purple",  alpha=0.5) +
  #coord_sf(xlim = c(-79, -65.5), ylim = c(33, 45)) +
  coord_sf(xlim =c(-78, -65.5), ylim = c(35, 45)) +
  ggtitle("c. State waters (purple), in MABGB (green)")

```


Seasonal models were run using the script [`bluefishdiet/VASTunivariate_bfp_allsurvs_lencovSST_ALLinoffsplits.R`](https://github.com/sgaichas/bluefishdiet/blob/main/VASTunivariate_bfp_allsurvs_lencovSST_ALLinoffsplits.R), which contains all stratum definitions. The annual model was run using the script [`bluefishdiet/VASTunivariate_bfp_allsurvsANNUA:_lencovSST_ALLinoffsplits.R`](https://github.com/sgaichas/bluefishdiet/blob/main/VASTunivariate_bfp_allsurvsANNUAL_lencovSST_ALLinoffsplits.R). 

The final model runs included all selected covariates, stratum definitions, and bias correction for the biomass index.  

### Comparisons with survey-design based forage biomass 

The forage species list based on diet data was matched to survey species lists to aggregate NEFSC bottom trawl survey CPUE for the same set of species. VAST-derived diet based spring and fall forage indices for large spatial units matching ecosystem reporting production units (Gulf of Maine, Georges Bank, and Mid-Atlantic Bight) were standardized by centering on the time series mean and dividing by the time series standard deviation. Aggregate design-based survey biomass was similarly standardized, and the correlation between the diet based and biomass based indices was calculated for each region and season. Raw species composition of the diet based and biomass based forage datasets were compared to evaluate whether the proportion of managed to unmanaged species and individual dominant species were similar.  

# Results  

## Input dataset overview 

```{r dietsumm}
bluefishaggdiet <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).All.2021-10-07.csv"))

# decadal diet
diet70 <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).1970s.2021-10-07.csv")) %>%
  mutate(Decade = 1970)
diet80 <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).1980s.2021-10-07.csv"))%>%
  mutate(Decade = 1980)
diet90 <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).1990s.2021-10-07.csv"))%>%
  mutate(Decade = 1990)
diet00 <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).2000s.2021-10-07.csv"))%>%
  mutate(Decade = 2000)
diet10 <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).2010s.2021-10-07.csv"))%>%
  mutate(Decade = 2010)

bluefishdecadediet <- bind_rows(diet70, diet80, diet90, diet00, diet10)

# seasonal diet
dietspring <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).SPRING.2021-10-07.csv"))%>%
  mutate(Season = "Spring")
dietfall <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).FALL.2021-10-07.csv"))%>%
  mutate(Season = "Fall")

bluefishseasondiet <- bind_rows(dietspring, dietfall)

# regional diet
dietMAB <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).MID-ATLANTIC BIGHT.2021-10-07.csv")) %>%
  mutate(Region = "MAB")
dietSNE <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).SOUTHERN NEW ENGLAND.2021-10-07.csv"))%>%
  mutate(Region = "SNE")
dietGB <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).GEORGES BANK.2021-10-07.csv"))%>%
  mutate(Region = "GB")

bluefishregiondiet <- bind_rows(dietMAB, dietSNE, dietGB)

# bluefish size diet
dietSM <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).S.2021-10-07.csv")) %>%
  mutate(Size = "Small")
dietMED <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).M.2021-10-07.csv"))%>%
  mutate(Size = "Medium")
dietLG <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).L.2021-10-07.csv"))%>%
  mutate(Size = "Large")

bluefishsizediet <- bind_rows(dietSM, dietMED, dietLG)

preylist <- unique(c(bluefishaggdiet$Prey, bluefishdecadediet$Prey, bluefishregiondiet$Prey, bluefishseasondiet$Prey, bluefishsizediet$Prey))

```

```{r preycol}
#from http://medialab.github.io/iwanthue/ using 35 categories, colorblind friendly
# again from http://medialab.github.io/iwanthue/ All colors colorspace, colorblind friendly, hard
preycol <- c("#00495d",
"#3ac100",
"#a646f7",
"#72ff75",
"#8d00a6",
"#c6ff90",
"#0268f1",
"#ff8d23",
"#0144a6",
"#01a249",
"#e1009e",
"#abffe1",
"#7e0082",
"#fffdd4",
"#24001c",
"#bbf6ff",
"#a60029",
"#0176c8",
"#8a4700",
"#a083ff",
"#454400",
"#ff7fff",
"#005d35",
"#c9005e",
"#00483e",
"#ff96e4",
"#291d00",
"#d5a5ff",
"#2e0400",
"#ffc5d6",
"#00285f",
"#ffbb88",
"#4a002e",
"#ff8092",
"#68001a")
names(preycol) <- as.factor(preylist)

```

The list of bluefish prey derived from the most common identifiable prey items in NEFSC diet database (Table \@ref(tab:preylist)) includes the majority of bluefish diet composition by decade (Fig. \@ref(fig:decadediet)) and season (Fig. \@ref(fig:seasondiet)). Colors in the plots show included prey, while gray sections represent "fish unidentified" and other categories not included in this analysis. Even when evaluated annually and seasonally (where bluefish sample sizes may be small for a year-season combination), a majority of observed diet is included in the dataset for analysis (Fig. \@ref(fig:yearseasondiet)). 

```{r decadediet, fig.cap="Bluefish diet by decade, NEFSC bottom trawl surveys.", eval=FALSE}
preycolsel <- preycol[toupper(names(preycol)) %in% blueprey$pynam] 

preycolaggsel <- replace(preycolsel, names(preycolsel), "blue")

p <- ggplot(bluefishdecadediet, aes(x=as.factor(Decade), y=Pct.m, fill=Prey)) +
  geom_bar_interactive(width = 0.95, stat = "identity", show.legend = FALSE,
                       aes(tooltip = Prey, data_id = Prey))+
  scale_fill_manual(values=preycolaggsel) +         #custom colors
  ggthemes::theme_tufte()
ggiraph(code=print(p))
#p
```

  
```{r seasondiet, fig.cap="Bluefish diet by season, NEFSC bottom trawl surveys.", eval=FALSE}
preycolsel <- preycol[toupper(names(preycol)) %in% blueprey$pynam] 

p <- ggplot(bluefishseasondiet, aes(x=as.factor(Season), y=Pct.m, fill=Prey)) +
  geom_bar_interactive(width = 0.95, stat = "identity", show.legend = FALSE,
                       aes(tooltip = Prey, data_id = Prey))+
  scale_fill_manual(values=preycolaggsel) +         #custom colors
  ggthemes::theme_tufte()
ggiraph(code=print(p))
#p
```


```{r yearseasondiet, eval=FALSE}
source(here("get_diet.R"))

bluefish <- get_diet(135) 

# try for facet decade/season with included prey highlighted in blue
bluefishdecseastot <- bluefish %>%
  # make decade column
  # make 2 seasons winter--> spring and summer--> fall
  dplyr::mutate(decade = floor(year/10)*10,
                season2 = case_when(season %in% c("WINTER", "SPRING") ~ "SPRING",
                                    season %in% c("SUMMER", "FALL") ~ "FALL")) %>%
                #season2 = case_when(season %in% c( "SPRING") ~ "SPRING",
                #                    season %in% c( "FALL") ~ "FALL")) %>%
  dplyr::select(decade, season2, totwt) %>%
  dplyr::distinct() %>%
  dplyr::group_by(decade, season2) %>%
  dplyr::mutate(totwt2 = sum(totwt, na.rm = TRUE),
                nyrs = n_distinct(year)) %>%
  dplyr::select(decade, season2, totwt2, nyrs) %>%
  dplyr::distinct()
  
bluefishdecseas <- bluefish %>%   
  # make decade column
  # make 2 seasons winter--> spring and summer--> fall
  dplyr::mutate(decade = floor(year/10)*10,
                season2 = case_when(season %in% c("WINTER", "SPRING") ~ "SPRING",
                                    season %in% c("SUMMER", "FALL") ~ "FALL")) %>%
                #season2 = case_when(season %in% c( "SPRING") ~ "SPRING", 
                #                    season %in% c( "FALL") ~ "FALL")) %>%
  # sum meansw by decade, season, prey
  dplyr::group_by(decade, season2, prey) %>%
  # recalculate relmsw
  dplyr::summarise(meansw = sum(meansw, na.rm = TRUE)) %>%
  dplyr::left_join(bluefishdecseastot) %>%
  dplyr::mutate(relmsw = meansw/totwt2) %>%
  dplyr::mutate(blueprey = ifelse(prey %in% blueprey$pynam, TRUE, FALSE),
                plotcol = ifelse(blueprey, "blue", "lightgrey")) %>% 
  dplyr::group_by(decade, season2) %>%
  dplyr::arrange(desc(blueprey), .by_group = TRUE)
  #dplyr::arrange(blueprey, .by_group = TRUE)

# preycolsel <- preycol[toupper(names(preycol)) %in% blueprey$pynam] 
# names(preycolsel) <- toupper(names(preycolsel))
# 
# preycolaggsel <- replace(preycolsel, names(preycolsel), "blue")

bars <- map(unique(bluefishdecseas$decade)
            , ~geom_bar(aes(width=nyrs), stat = "identity", colour = "white"#, position = "stack"
                       , data = bluefishdecseas %>% filter(decade == .x)))


p1 <-   ggplot(bluefishdecseas, aes(decade, relmsw, fill=plotcol)) +
                                    #fill=factor(prey, 
                                    #            levels = c(as.factor(names(preycolaggsel)),
                                    #                       setdiff(prey, preycolaggsel)),
                                    #           ordered = TRUE
                                    #           ))) +
   #geom_bar(aes(width=nyrs), stat = "identity") + #
   bars +
   ylab("Percent in Diet") +
   xlab("Decade") +
   geom_text(aes(y=relmsw, 
             label = ifelse(relmsw > 0.03, prey, "")),
             position = position_stack(vjust = 0.5),
             size=1.5)+
   facet_wrap(~fct_relevel(season2, "SPRING", "FALL")) +
   theme_bw() +
   #viridis::scale_fill_viridis(discrete = TRUE) +
   scale_fill_manual(values=c("lightblue", "grey90")) + 
   theme(legend.position = "none"
         #legend.position="bottom",
         #legend.text=element_text(size=5)
         ) #+
    #geom_bar_interactive(stat = "identity", aes(tooltip = prey, data_id = prey))

#ggiraph(code = print(p1)) 
#p1
```

```{r seasondecade, fig.cap="Bluefish diet by season and decade, NEFSC bottom trawl surveys."}
source(here("get_diet.R"))

bluefish <- get_diet(135) 

# try for facet decade/season with included prey highlighted in blue
bluefishdecseastot <- bluefish %>%
  # make decade column
  # make 2 seasons winter--> spring and summer--> fall
  dplyr::mutate(decade = floor(year/10)*10,
                season2 = case_when(season %in% c("WINTER", "SPRING") ~ "SPRING",
                                    season %in% c("SUMMER", "FALL") ~ "FALL")) %>%
                #season2 = case_when(season %in% c( "SPRING") ~ "SPRING",
                #                    season %in% c( "FALL") ~ "FALL")) %>%
  dplyr::select(decade, season2, totwt) %>%
  dplyr::distinct() %>%
  dplyr::group_by(decade, season2) %>%
  dplyr::mutate(totwt2 = sum(totwt, na.rm = TRUE),
                nyrs = n_distinct(year)) %>%
  dplyr::select(decade, season2, totwt2, nyrs) %>%
  dplyr::distinct()

briansdat <- read.csv(here("fhdat/allwt_135_seas_dec.csv"))

# add blueprey list
briansdecadeseason <- briansdat %>%
  dplyr::mutate(blueprey = ifelse(collsci %in% blueprey$pynam, TRUE, FALSE),
                plotcol = ifelse(blueprey, "blue", "lightgrey"),
                decade = as.integer(gsub("s","",decade))) %>%
  dplyr::left_join(bluefishdecseastot, by=c("seacat" = "season2", 
                                            "decade" = "decade")) %>%
  dplyr::group_by(decade, seacat) %>%
  dplyr::filter(meansw>0) %>%
  dplyr::arrange(desc(blueprey), .by_group = TRUE)


bars <- map(unique(briansdecadeseason$decade)
            , ~geom_bar(aes(width=nyrs), stat = "identity", colour = "white"#, position = "stack", 
                       , data = briansdecadeseason %>% filter(decade == .x)))


p2 <-   ggplot(briansdecadeseason, aes(decade, relmsw, fill=blueprey)) +
                                    #fill=factor(prey, 
                                    #            levels = c(as.factor(names(preycolaggsel)),
                                    #                       setdiff(prey, preycolaggsel)),
                                    #           ordered = TRUE
                                    #           ))) +
   #geom_bar(aes(width=nyrs), stat = "identity") + #
   bars +
   ylab("Percent in Diet") +
   xlab("Decade") +
   geom_text(aes(y=relmsw, 
             label = ifelse(relmsw > 3, collsci, "")),
             position = position_stack(vjust = 0.5),
             size=1.5)+
   facet_wrap(~fct_relevel(seacat, "SPRING", "FALL")) +
   theme_bw() +
   #viridis::scale_fill_viridis(discrete = TRUE) +
   scale_fill_manual(values=c( "grey90", "lightblue")) + 
   theme(legend.position = "none"
         #legend.position="bottom",
         #legend.text=element_text(size=5)
         ) #+
    #geom_bar_interactive(stat = "identity", aes(tooltip = prey, data_id = prey))

#ggiraph(code = print(p1)) 
#p1

```


```{r datasetsumm}

# total diet observations (n hauls) 1985-2021
ndietNEFSC <- allfh %>%
  filter(year>1984) %>%
  group_by(year, season, station) %>%
  summarise() %>%
  nrow()

# total piscivore diet observations (n hauls) 1985-2021
fh.nefsc.pisc.pisccomplete <- allfh %>%
  #filter(pynam != "EMPTY") %>%
  left_join(pisccompletedf, by = c("pdcomnam" = "COMNAME",
                               "sizecat" = "SizeCat")) %>%
  filter(!is.na(feedguild)) %>%
  mutate(blueprey = case_when(pynam %in% blueprey$pynam ~ "blueprey",
                              TRUE ~ "othprey"))


ndietpiscNEFSC <- fh.nefsc.pisc.pisccomplete %>%
  filter(year>1984) %>%
  group_by(year, season, station) %>%
  summarise() %>%
  nrow()  

# total piscivore observations with bluefish prey
nbfpreyNEFSC <- fh.nefsc.pisc.pisccomplete %>%
  filter(year>1984,
         blueprey == "blueprey") %>%
  group_by(year, season, station) %>%
  summarise() %>%
  nrow()  

# total bluefish diet observations (n hauls) 1985-2021
ndietbfNEFSC <- fh.nefsc.pisc.pisccomplete %>%
  filter(year>1984,
         pdcomnam == "BLUEFISH") %>%
  group_by(year, season, station) %>%
  summarise() %>%
  nrow()  

# bluefish diet observations with bluefish prey (n hauls) 1985-2021
ndietbfbfpreyNEFSC <- fh.nefsc.pisc.pisccomplete %>%
  filter(year>1984,
         pdcomnam == "BLUEFISH",
         blueprey == "blueprey") %>%
  group_by(year, season, station) %>%
  summarise() %>%
  nrow()  

# NEAMAP totals?


# NEAMAP piscivores and bluefish
neamap_bluepreyagg_stn <- read_csv(here("fhdat/NEAMAP_Mean stomach weights_Bluefish PreyWQ2.csv")) %>%
  mutate(vessel = "NEAMAP") %>%
  rename(id = station,
         sumbluepywt = sumbluepreywt,
         nbluepysp = nbfpreyspp,
         #npreysp = ,
         npiscsp = npiscspp,
         nstomtot = nstomtot, 
         meanbluepywt = meanbluepreywt,
         meanpisclen = meanpisclen.simple, 
         #varpisclen = ,
         season_ng = season,
         declat  = lat,
         declon = lon,
         bottemp = bWT,
         #surftemp = , 
         setdepth = depthm) 

# check for incorrect NEAMAP station
#bluepyagg_stn %>% filter(id == "NM20070901011") # has this station
# if sumbluepywt is 106564.2, this is incorrect
# corrected by Jim Gartland in September 2022

# correct single NEAMAP station 
neamap_bluepreyagg_stn$sumbluepywt[neamap_bluepreyagg_stn$id == "NM20070901011"] <- 4.8404
neamap_bluepreyagg_stn$meanbluepywt[neamap_bluepreyagg_stn$id == "NM20070901011"] <- 0.186169231


neamap_npisctows <- neamap_bluepreyagg_stn %>%
  nrow()

neamap_nbfpreytows <- neamap_bluepreyagg_stn %>%
  filter(meanbluepywt>0) %>%
  nrow()



```

The full NEFSC diet database 1985-2021 contains `r ndietNEFSC` survey stations with diet collections. When including only piscivores feeding similarly to bluefish, the survey stations with diet collections in this time period is `r ndietpiscNEFSC`. Of these piscivore diet stations, `r nbfpreyNEFSC` included our defined bluefish prey, or `r nbfpreyNEFSC/ndietpiscNEFSC*100`%. For comparison, `r ndietbfNEFSC` stations have diet samples for bluefish alone, with `r ndietbfbfpreyNEFSC` or `r ndietbfbfpreyNEFSC/ndietbfNEFSC*100`% including our defined bluefish prey.

NEAMAP survey stations with diet collections for piscivores (n = `r neamap_npisctows`) had a higher proportion with our defined bluefish prey (n = `r neamap_nbfpreytows`, `r (neamap_nbfpreytows/neamap_npisctows)*100`%). 

The number of survey stations missing surface temperature data varied considerably by decade. A large percentage of survey stations lacked in-situ temperature measurements between 1985 and 1990, while the percentage of stations missing temperature was generally below 10% (with a few exceptions) from 1991-2021 (Table \@ref(tab:sstdat)). Therefore, OISST temperature estimates were more commonly substituted early in the time series. 

```{r sstdat, eval=FALSE}
#[add stuff about how many SST values were missing and which years got substituted]

inputdat <- readRDS(here("fhdat/bluepyagg_stn_all_OISST.rds"))

stnsummary <- inputdat %>%
  dplyr::filter(year>1984) %>%
  dplyr::group_by(year, season_ng) %>%
  dplyr::summarise(nstation = n(),
                   hastemp = sum(!is.na(surftemp))) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(percentmiss = (nstation - hastemp)/nstation*100) %>%
  tidyr::pivot_wider(names_from = season_ng,
    values_from = c(nstation, hastemp, percentmiss)) %>%
  dplyr::select(year, nstation_SPRING, hastemp_SPRING, percentmiss_SPRING,
                nstation_FALL, hastemp_FALL, percentmiss_FALL)

flextable::flextable(stnsummary) %>%
  flextable::set_header_labels(year = 'Year', 
                               nstation_SPRING = "Spring N stations", 
                               hastemp_SPRING = "Spring N stations with in situ temperature",
                               percentmiss_SPRING = "Spring percent missing temperature",
                               nstation_FALL = "Fall N stations", 
                               hastemp_FALL = "Fall N stations with in situ temperature",
                               percentmiss_FALL = "Fall percent missing temperature") %>%
  flextable::set_caption("Number of survey stations by year and season with in situ sea surface temperature measurements.") %>%
  flextable::colformat_double(big.mark = "", digits = 0) %>%
  #flextable::autofit()
  flextable::width(width = 1)

```

## VAST model selection  

Comparisons of AIC are presented for both the first (spatial and spatio-temporal random effects, Table \@ref(tab:modsel1)) and second (catchability covariates, Table \@ref(tab:modsel2)) rounds of model selection. 

```{r}

# from each output folder in pyindex, 
outdir <- here("pyindex_modsel1")
moddirs <- list.dirs(outdir) 
moddirs <- moddirs[-1]
# keep folder name
modnames <- list.dirs(outdir, full.names = FALSE)


# function to apply extracting info
getmodinfo <- function(d.name){
  # read settings
  modpath <- stringr::str_split(d.name, "/", simplify = TRUE)
  modname <- modpath[length(modpath)]
  
  settings <- read.table(file.path(d.name, "settings.txt"), comment.char = "",
    fill = TRUE, header = FALSE)
  
  n_x <- as.numeric(as.character(settings[(which(settings[,1]=="$n_x")+1),2]))
  grid_size_km <- as.numeric(as.character(settings[(which(settings[,1]=="$grid_size_km")+1),2]))
  max_cells <- as.numeric(as.character(settings[(which(settings[,1]=="$max_cells")+1),2]))
  use_anisotropy <- as.character(settings[(which(settings[,1]=="$use_anisotropy")+1),2])
  fine_scale <- as.character(settings[(which(settings[,1]=="$fine_scale")+1),2])
  bias.correct <- as.character(settings[(which(settings[,1]=="$bias.correct")+1),2])
  
  #FieldConfig
  if(settings[(which(settings[,1]=="$FieldConfig")+1),1]=="Component_1"){
    omega1 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+2),2])
    omega2 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+3),1])
    epsilon1 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+4),2])
    epsilon2 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+5),1])
    beta1 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+6),2])
    beta2 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+7),1])
  }
  
  if(settings[(which(settings[,1]=="$FieldConfig")+1),1]=="Omega1"){
    omega1 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+3),1])
    omega2 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+4),1])
    epsilon1 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+3),2])
    epsilon2 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+4),2])
    beta1 <- "IID"
    beta2 <- "IID"
  }
  
  
  #RhoConfig
  rho_beta1 <- as.numeric(as.character(settings[(which(settings[,1]=="$RhoConfig")+3),1]))
  rho_beta2 <- as.numeric(as.character(settings[(which(settings[,1]=="$RhoConfig")+3),2]))
  rho_epsilon1 <- as.numeric(as.character(settings[(which(settings[,1]=="$RhoConfig")+4),1]))
  rho_epsilon2 <- as.numeric(as.character(settings[(which(settings[,1]=="$RhoConfig")+4),2]))
  
  # read parameter estimates, object is called parameter_Estimates
  load(file.path(d.name, "parameter_estimates.RData"))
  
  AIC <- parameter_estimates$AIC[1]  
  converged <- parameter_estimates$Convergence_check[1]
  fixedcoeff <- unname(parameter_estimates$number_of_coefficients[2])
  randomcoeff <- unname(parameter_estimates$number_of_coefficients[3])
  
  #index <- read.csv(file.path(d.name, "Index.csv"))
  
  
  # return model attributes as a dataframe
  out <- data.frame(modname = modname,
                    n_x = n_x,
                    grid_size_km = grid_size_km,
                    max_cells = max_cells,
                    use_anisotropy = use_anisotropy,
                    fine_scale =  fine_scale,
                    bias.correct = bias.correct,
                    omega1 = omega1,
                    omega2 = omega2,
                    epsilon1 = epsilon1,
                    epsilon2 = epsilon2,
                    beta1 = beta1,
                    beta2 = beta2,
                    rho_epsilon1 = rho_epsilon1,
                    rho_epsilon2 = rho_epsilon2,
                    rho_beta1 = rho_beta1,
                    rho_beta2 = rho_beta2,
                    AIC = AIC,
                    converged = converged,
                    fixedcoeff = fixedcoeff,
                    randomcoeff = randomcoeff#,
                    #index = index
  )
  	
	return(out)

}


modcompare <- purrr::map_dfr(moddirs, getmodinfo)
```

Models compared using REML are identified by model name ("modname" in Tables \@ref(tab:modsel1)) which includes all prey aggregated ("allagg" for all models), season ("all" for annual models of months 1-12, "fall" for models of months 7-12, and "spring" for models of months 1-6), number of knots (500 for all models), and which fixed and random spatial and spatio-temporal effects were included in which linear predictor (1 or 2). The names for model options and associated VAST model settings are:

Model selection 1 (spatial, spatio-temporal effects, no covariates) options (following @ng_predator_2021) and naming:
*  All models set Use_REML = TRUE in fit_model specifications.  
*  Modeled effects, model name suffix, and VAST settings by model:  

1.  "_alleffectson" = Spatial and spatio-temporal random effects plus anisotropy in both linear predictors; FieldConfig default (all IID)
1.  "_noaniso" = Spatial and spatio-temporal random effects in both linear predictors with anisotopy turned off; FieldConfig default (all IID) and `use_anisotopy = FALSE`
1.  "_noomeps2" = Spatial and spatio-temporal random effects plus anisotropy only in linear predictor 1;   FieldConfig = 0 for Omega2, Epsilon2
1.  "_noomeps2_noaniso" = Spatial and spatio-temporal random effects only in linear predictor 1 with anisotopy turned off;  FieldConfig = 0 for Omega2, Epsilon2 and `use_anisotopy = FALSE`
1. "_noomeps2_noeps1" =  Spatial random effects plus anisotropy only in linear predictor 1;   FieldConfig = 0 for Omega2, Epsilon2, Epsilon1
1.  "_noomeps2_noeps1_noaniso" = Spatial random effects only in linear predictor 1 with anisotopy turned off;   FieldConfig = 0 for Omega2, Epsilon2, Epsilon1 and `use_anisotopy = FALSE`
1.  "_noomeps12" = Anisotropy, but no spatial or spatio-temporal random effects in either linear predictor;   FieldConfig = 0 for both Omega, Epsilon 
1.  "_noomeps12_noaniso" = No spatial or spatio-temporal random effects in either linear predictor;  FieldConfig = 0 for both Omega, Epsilon  and `use_anisotopy = FALSE`


```{r modsel1}
modselect <- modcompare %>%
  dplyr::mutate(season = case_when(str_detect(modname, "_fall_") ~ "Fall",
                            str_detect(modname, "spring") ~ "Spring",
                            str_detect(modname, "_all_") ~ "Annual",
                            TRUE ~ as.character(NA))) %>%
  dplyr::mutate(converged2 = case_when(str_detect(converged, "no evidence") ~ "likely",
                                str_detect(converged, "is likely not") ~ "unlikely",
                                TRUE ~ as.character(NA))) %>%
  dplyr::group_by(season) %>%
  dplyr::mutate(deltaAIC = AIC-min(AIC)) %>%
  dplyr::select(modname, season, deltaAIC, fixedcoeff,
         randomcoeff, use_anisotropy, 
         omega1, omega2, epsilon1, epsilon2, 
         beta1, beta2, AIC, converged2) %>%
  dplyr::arrange(season, AIC)

DT::datatable(modselect, rownames = FALSE, 
              options= list(pageLength = 25, scrollX = TRUE),
              caption = "Comparison of delta AIC values using Restricted Maxiumum Likelihood (REML) for alternative fixed and random effects model structures. See text for model descriptions.")
```

Using REML, models including spatial and spatio-temporal random effects as well as anisotropy were best supported by the data. This was true for the spring dataset, the fall dataset, and the annual (seasons combined) dataset. 

For the second round of model selection with different combinations of vessel effects and or catchability covariates, "modname" in \@ref(tab:modsel2) follows a similar pattern as above, with  all prey aggregated ("allagg" for all models), season ("all" for annual models of months 1-12, "fall" for models of months 7-12, and "spring" for models of months 1-6), number of knots (500 for all models), and which vessel effects or covariates were included. The names for model options and associated VAST model settings are: 

Model selection 2 (covariates) options, FieldConfig default (all IID), with anisotropy:

1.  "_base" =          No vessel overdispersion or length/number covariates   
1.  "_len" =           Predator mean length covariate
1.  "_num" =           Number of predator species covariate
1.  "_lennum" =        Predator mean length and number of predator species covariates
1.  "_sst" =           Combined in situ and OISST covariate
1.  "_lensst" =        Predator mean length and SST covariates
1.  "_numsst" =        Number of predator species and SST covariates
1.  "_lennumsst" =     Predator mean length, number of predator species, and SST covariates
1.  "_eta10" =         Overdispersion (vessel effect) in first linear predictor (prey encounter)
1.  "_eta11" =         Overdispersion (vessel effect) in both linear predictors (prey encounter and weight)


```{r modsel2}
# from each output folder in pyindex, 
outdir <- here("pyindex_modsel2")
moddirs <- list.dirs(outdir) 
moddirs <- moddirs[-1]
# keep folder name
modnames <- list.dirs(outdir, full.names = FALSE)

modcompare2 <- purrr::map_dfr(moddirs, getmodinfo)

modselect2 <- modcompare2 %>%
  dplyr::mutate(season = case_when(str_detect(modname, "_fall_") ~ "Fall",
                            str_detect(modname, "spring") ~ "Spring",
                            str_detect(modname, "_all_") ~ "Annual",
                            TRUE ~ as.character(NA))) %>%
  dplyr::mutate(converged2 = case_when(str_detect(converged, "no evidence") ~ "likely",
                                str_detect(converged, "is likely not") ~ "unlikely",
                                TRUE ~ as.character(NA))) %>%
  dplyr::group_by(season) %>%
  dplyr::mutate(deltaAIC = AIC-min(AIC)) %>%
  dplyr::select(modname, season, deltaAIC, fixedcoeff,
         randomcoeff, use_anisotropy, 
         omega1, omega2, epsilon1, epsilon2, 
         beta1, beta2, AIC, converged2) %>%
  dplyr::arrange(season, AIC)

DT::datatable(modselect2, rownames = FALSE, 
              options= list(pageLength = 50, scrollX = TRUE),
              caption = "Comparison of delta AIC values for alternative vessel effects and catchability covariates. See text for model descriptions.")

```


Catchability covariates were better supported by the data than vessel effects. Model comparisons above and [here](https://sgaichas.github.io/bluefishdiet/VASTcovariates_updatedPreds_sst.html) led us to the best model fit using mean predator length, number of predator species, and SST at a survey station as catchability covariates. 

## Bias-corrected spatial forage indices  

Indices were calculated at multiple spatial scales for Fall, Spring, and Annual models. Here we focus on results for Fall models, which most closely match the timing of bluefish assessment inputs. Spring and Annual model outputs and diagnostics are available in Supplement 1. 

```{r}
# strata.limits <- as.list(c("AllEPU" = allEPU2, 
#                            "MABGB" = MABGB2,
#                            "MABGBstate" = MABGBstate,
#                            "MABGBfed" = MABGBfed,
#                            "MAB" = MAB2,
#                            "GB" = GB2,
#                            "GOM" = GOM2,
#                            "bfall" = bfall2,
#                            "bfin" = bfinshore2,
#                            "bfoff" = bfoffshore2,
#                            "MABGBalbinshore" = albinshore2,
#                            "MABGBothoffshore" = MABGBothoffshore2,
#                            "albbfin" = albbfinshore,
#                            "albbfall" = albbfall,
#                            "allother" = allother2))

stratlook <- data.frame(Stratum = c("Stratum_1",
                                    "Stratum_2",
                                    "Stratum_3",
                                    "Stratum_4",
                                    "Stratum_5",
                                    "Stratum_6",
                                    "Stratum_7",
                                    "Stratum_8",
                                    "Stratum_9",
                                    "Stratum_10",
                                    "Stratum_11",
                                    "Stratum_12",
                                    "Stratum_13",
                                    "Stratum_14",
                                    "Stratum_15"),
                        Region  = c("AllEPU", 
                                    "MABGB", 
                                    "MABGBstate", 
                                    "MABGBfed", 
                                    "MAB",
                                    "GB",
                                    "GOM",
                                    "bfall",
                                    "bfin",
                                    "bfoff",
                                    "MABGBalbinshore",
                                    "MABGBothoffshore",
                                    "albbfin",
                                    "albbfall",
                                    "allother"))

```

### Fall Index  

Many indices for different spatial strata can be derived from the VAST model. Fall indices (Fig. \@ref(fig:fallall)) for the full spatial domain (AllEPU) through smaller strata were produced. The same regions are used for all models. 

```{r fallall, fig.cap="All Fall forage indices"}
splitoutput <- read.csv("pyindex/allagg_fall_500_lennosst_ALLsplit_biascorrect/Index.csv")

splitoutput <- splitoutput %>%
  left_join(stratlook)

ggplot(splitoutput, aes(x=Time, y=Estimate, colour=Region)) +
  geom_errorbar(aes(ymin=Estimate+Std..Error.for.Estimate, ymax=Estimate-Std..Error.for.Estimate))+
  geom_point()+
  geom_line()+
  facet_wrap(~Region, scales = "free_y") +
  guides(colour = guide_legend(ncol=2)) +
  #theme(legend.position = c(1, 0),
   #     legend.justification = c(1, 0))
  theme(legend.position="none")

```

We can compare the indices relevant to bluefish on the same scale: inshore (Albatross strata), inshore bluefish, offshore bluefish, and further out, plus the state and federal waters split (Fig. \@ref(fig:fallsome)).
 
```{r fallsome, fig.cap="Bluefish-related Fall forage indices"}
in2off <- splitoutput %>%
  dplyr::select(Time, Region, Estimate, Std..Error.for.Estimate) %>%
  tidyr::pivot_longer(c(Estimate, Std..Error.for.Estimate), names_to = "Var") %>%
  dplyr::group_by(Var) %>%
  tidyr::pivot_wider(names_from = Region, values_from = value) %>%
  dplyr::mutate(AlbInshore = MABGBalbinshore,
                BlueInshore = bfin,
                BlueOffshore = bfoff,
                #OthOffshore = MABGB - (bfoff + bfin + MABGBalbinshore),
                OthOffshore = MABGBothoffshore,
                StateWaters = MABGBstate,
                FedWaters =   MABGBfed,
                SumMABGB = AlbInshore + BlueInshore + BlueOffshore + OthOffshore) %>%
  dplyr::select(Time, AlbInshore, BlueInshore, BlueOffshore, OthOffshore, SumMABGB, StateWaters, FedWaters, MABGB) %>%
  tidyr::pivot_longer(!c(Time, Var), names_to = "Region", values_to = "value") %>%
  tidyr::pivot_wider(names_from = "Var", values_from = "value")

ggplot(in2off, aes(x=Time, y=Estimate, colour = Region)) +
  geom_errorbar(aes(ymin=Estimate+Std..Error.for.Estimate, ymax=Estimate-Std..Error.for.Estimate))+
  geom_point()+
  geom_line()+
  #facet_wrap(~Region) + #+ , scales = "free_y"
  #theme(legend.position = c(1, 0),
  #      legend.justification = c(1, 0))
  ggtitle("Fall Prey Index, Mid-Atlantic and Georges Bank")


```

Proportions of prey in each bluefish relevant area can be compared (here as a proportion of the full MABGB index; Fig. \@ref(fig:fallprop)).

```{r fallprop, fig.cap="Fall forage indices as proportion of the Mid Atlantic and Georges Bank area."}
MABGBprop <- in2off %>%
  #dplyr::filter(Region != "AllEPU") %>%
  dplyr::select(Time, Region, Estimate) %>%
  tidyr::pivot_wider(names_from = Region, values_from = Estimate) %>%
  dplyr::mutate(AlbInshoreprop = AlbInshore/MABGB,
                BlueInshoreprop = BlueInshore/MABGB,
                BlueOffshoreprop = BlueOffshore/MABGB,
                OthOffshoreprop = OthOffshore/MABGB,
                StateWatersprop = StateWaters/MABGB, 
                FedWatersprop = FedWaters/MABGB) %>%
  tidyr::pivot_longer(!Time, names_to = "Region", values_to = "Estimate") %>%
  dplyr::filter(Region %in% c("AlbInshoreprop", "BlueInshoreprop", "BlueOffshoreprop",
                              "OthOffshoreprop", "StateWatersprop", "FedWatersprop"))
  

ggplot(MABGBprop, aes(x=Time, y=Estimate, colour = Region)) +
  geom_point()+
  geom_line()+
  #facet_wrap(~Region) + #+ , scales = "free_y"
  #theme(legend.position = c(1, 0),
  #      legend.justification = c(1, 0))
  ggtitle("Fall Prey Index as proportion of Mid-Atlantic and Georges Bank")
  
  
```

### Fall predicted ln-density

The VAST model predicts density of forage fish across the entire model domain for each year (Fig. \@ref(fig:falldens)). 

```{r falldens, fig.cap="Yearly maps of VAST model estimated forage fish density for Fall (months 7-12)."}
knitr::include_graphics("pyindex/allagg_fall_500_lennosst_ALLsplit_biascorrect/ln_density-predicted.png")
```

<!--![Fall density maps with covariates](pyindex/allagg_fall_500_lennosst_ALLsplit_biascorrect/ln_density-predicted.png){#fig:falldens}-->
 
### Fall Diagnostics {.tabset}

Basic VAST diagnostics include maps of the spatial grid knot placement ("Data_and_knots"), maps of included station locations for each year ("Data_by_year"), residual plots ("quantile residuals"), maps of residuals for each station ("quantile_residuals_on_map"), an anisotropy plot indicating directional correlation ("Aniso"), and a plot of the estimated change in forage fish center of gravity over time ("center_of_gravity"). We present these plots for each of the models in numbered sections below.

```{r, results='asis'}

diagplots <- c("Data_and_knots",
               "Data_by_year",
               "quantile_residuals",
               "quantile_residuals_on_map",
               "Aniso",
               "center_of_gravity")

for(p in diagplots){
  
    cat("  \n####",  as.character(p),"  \n")
    cat(paste0("![Fall diagnostics:",
               p,
               "](pyindex/allagg_fall_500_lennosst_ALLsplit_biascorrect/",
                      p,
                      ".png)")) 
    cat("  \n")   
    
  }

```

### {-} 


## Woods Hole stock assessment model (WHAM) input time series

Current inputs for the bluefish assessment implemented in WHAM [@stock_woods_2021] include a subset of the stratum-specific indices calculated above. The index is calculated for each season and the annual model for several regions relevant to the bluefish assessment:

1.  Albatross New (AlbNew) includes all inshore and new offshore survey strata (largest area, combines area in Figs. \@ref(fig:albin), \@ref(fig:bluein), and \@ref(fig:blueoff))
1.  Albatross Old (AlbOld) includes all inshore survey strata (combines area in Figs. \@ref(fig:albin) and \@ref(fig:bluein))
1.  Bigelow New (BigNew) includes the subset of inshore survey strata that can be sampled by the R/V Henry Bigelow plus new offshore strata (combines area in Figs. \@ref(fig:bluein) and \@ref(fig:blueoff))
1.  Bigelow Old (BigOld) includes the subset of inshore survey strata that can be sampled by the R/V Henry Bigelow (area in Fig. \@ref(fig:bluein))
1.  StateWaters includes the coastline to 3 nautical miles offshore (smallest area, in Fig. \@ref(fig:statewaters))

WHAM model inputs were processed with the [`WHAMinputs.R`](https://github.com/sgaichas/bluefishdiet/blob/main/WHAMinputs.R) script.

```{r, code = readLines(here("WHAMinputs.R")), eval=F}
```

Indices in the strata above for input in to WHAM are plotted below (Fig. \@ref(fig:WHAMfall)).

```{r}
WHAMinputsviz <- function(infile) {
  
  splitoutput <- read.csv(infile)
  
  # warning, hardcoded. obviously
  stratlook <- data.frame(Stratum = c("Stratum_1",
                                      "Stratum_2",
                                      "Stratum_3",
                                      "Stratum_4",
                                      "Stratum_5",
                                      "Stratum_6",
                                      "Stratum_7",
                                      "Stratum_8",
                                      "Stratum_9",
                                      "Stratum_10",
                                      "Stratum_11",
                                      "Stratum_12",
                                      "Stratum_13",
                                      "Stratum_14",
                                      "Stratum_15"),
                          Region  = c("AllEPU", 
                                      "MABGB", 
                                      "MABGBstate", 
                                      "MABGBfed", 
                                      "MAB",
                                      "GB",
                                      "GOM",
                                      "bfall",
                                      "bfin",
                                      "bfoff",
                                      "MABGBalbinshore",
                                      "MABGBothoffshore",
                                      "albbfin",
                                      "albbfall",
                                      "allother"))
  
  forageindex <- splitoutput %>%
    left_join(stratlook) %>%
    dplyr::select(Time, Region, Estimate, SE=Std..Error.for.Estimate) %>%
    tidyr::pivot_longer(c(Estimate, SE), names_to = "Var") %>%
    dplyr::group_by(Var) %>%
    tidyr::pivot_wider(names_from = Region, values_from = value) %>%
    dplyr::mutate(BigOld = bfin,
                  BigNew = bfall,
                  AlbOld = albbfin, 
                  AlbNew = albbfall, 
                  StateWaters = MABGBstate,
                  FedWaters =   MABGBfed) %>%
    dplyr::select(Time, BigOld, BigNew, AlbOld, AlbNew, StateWaters) %>%
    tidyr::pivot_longer(!c(Time, Var), names_to = "Region", values_to = "value") %>%
    tidyr::pivot_wider(names_from = "Var", values_from = "value")
 
  ggplot(forageindex, aes(x=Time, y=Estimate, colour = Region)) +
    geom_errorbar(aes(ymin=Estimate+SE, ymax=Estimate-SE))+
    geom_point()+
    geom_line()
  
} 
```

### WHAM forage index time series Fall

```{r WHAMfall, fig.cap="Time series of VAST estimated fall forage indices for input into WHAM, 1985-2021"}
WHAMinputsviz(infile = "pyindex/allagg_fall_500_lennosst_ALLsplit_biascorrect/Index.csv")
```

All of the above indices were provided for testing within the WHAM-based bluefish assessment model.

## Comparisons with design-based survey biomass

The diet based forage index and survey biomass based index were well correlated in the Gulf of Maine during spring, weakly correlated on Georges Bank during spring, and uncorrelated during fall in all regions and in both seasons in the Mid-Atlantic. To determine what may drive some seasons and regions to have similar forage indices based on diet versus survey biomass, we examined raw species composition over time in each dataset, by region and season. We expected to find similar species compositions in Gulf of Maine during spring, and possibly a shared dominant species on Georges Bank during spring. 

```{r corr, fig.cap="Diet based forage index (stdForage) compared with survey based index (stdsurvForage) by season and region (GOM = Gulf of Maine, GB = Georges Bank, MAB = Mid Atlantic Bight). Pearson correlation coefficients (*R*) and correlation significance (*p*) are shown for each season/region."}

## Survey index I calculated in CompareVASTforageSOE.Rmd 

load(here('survdat/Aggregate_ForageIndex_Survey.RData'))

survforage <- survey.data %>%
  dplyr::filter(Var %in% c("ForageIndex Fall Biomass Index",
                           "ForageIndex Spring Biomass Index",
                           "ForageIndex Fall Biomass Standard Error",
                           "ForageIndex Spring Biomass Standard Error"),
                Region %in% c("MAB", "GB", "GOM")) %>%
  tidyr::separate(Var, c("feeding.guild", "season", "Biomass", "Var1", NA), sep = " ") %>%
  tidyr::unite("Var", feeding.guild:season, sep = " ") %>%
  dplyr::mutate(stat = recode(Var1, Index = "Mean",
                      Standard = "SD")) %>%
  dplyr::select(-Biomass, -Var1,  -Units) %>%
  # dplyr::filter(!Area == "-") %>%
  dplyr::group_by(Var, Time, Region) %>%
  tidyr::pivot_wider(id_cols = c(Var, Time, Region),names_from =  stat, values_from =  Value) %>%
  dplyr::filter(!Mean == "NULL") %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Mean = as.numeric(Mean))

survforage <- survforage %>%
  dplyr::group_by(Var, Region) %>%
  dplyr::mutate(hline = mean(Mean, na.rm = T), 
                tssd = sd(SD, na.rm = T),
                 upper = Mean + (2*SD),
                lower = Mean - (2*SD)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(stdsurvForage = (Mean-hline)/tssd,
                #cv = SD/Mean,
                stdsurvForageupper = (upper-hline)/tssd,
                stdsurvForagelower = (lower-hline)/tssd)

survforage$Var <- factor(survforage$Var,levels = c("ForageIndex Spring",
                                                    "ForageIndex Fall"))
survforage$Region <- factor(survforage$Region, levels = c("GOM", "GB", "MAB"))

series.col <- rep("black",length(unique(survforage$Var)))
facet_names <- list("Forage" = expression("Forage")
                    )

survforage <- survforage %>%
  mutate(CompVar = recode(Var, "ForageIndex Spring" = "Spring",
                         "ForageIndex Fall" = "Fall"))  %>%
  rename(EPU = Region)
  

survforage$CompVar <- factor(survforage$CompVar,levels = c("Spring",
                                                    "Fall"))
#### Forage Index from ecodata
forage <- ecodata::forage_index %>%
  dplyr::filter(Var %in% c(#"Annual Forage Fish Biomass Estimate",
                           #"Annual Forage Fish Biomass Estimate SE",
                           "Fall Forage Fish Biomass Estimate",
                           "Fall Forage Fish Biomass Estimate SE",
                           "Spring Forage Fish Biomass Estimate",
                           "Spring Forage Fish Biomass Estimate SE"),
                EPU %in% c("GOM", "GB", "MAB"))%>%
  tidyr::separate(Var, c("season", "feeding.guild", NA,"Biomass", NA, "Var1"), sep = " ", extra = "drop", fill = "right") %>% 
  tidyr::unite("Var", feeding.guild:season, sep = " ") %>%
  dplyr::mutate(stat = recode(Var1, .missing = "Mean",
                      SE = "SD")) %>%
  dplyr::select(-Biomass, -Var1, -Units) %>%
  # dplyr::filter(!Area == "-") %>%
  dplyr::group_by(Var, Time, EPU) %>%
  tidyr::pivot_wider(id_cols = c(Var, Time, EPU),names_from =  stat, values_from =  Value) %>%
  dplyr::filter(!Mean == "NULL") %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Mean = as.numeric(Mean))

forage_std <- forage %>%
  dplyr::group_by(Var, EPU) %>%
  dplyr::mutate(hline = mean(Mean, na.rm = T), 
                tssd = sd(SD, na.rm = T),
                 upper = Mean + (2*SD),
                lower = Mean - (2*SD)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(stdForage = (Mean-hline)/tssd,
                #cv = SD/Mean,
                stdForageupper = (upper-hline)/tssd,
                stdForagelower = (lower-hline)/tssd)

forage_std$Var <- factor(forage_std$Var,levels = c("Forage Spring",
                                                    "Forage Fall"))
forage_std$EPU <- factor(forage_std$EPU, levels = c("GOM", "GB", "MAB"))
series.col <- rep("black",length(unique(forage_std$Var)))
facet_names <- list("Forage" = expression("Forage")
                    )
forage_std <- forage_std %>%
  mutate(CompVar = recode(Var, "Forage Spring" = "Spring",
                         "Forage Fall" = "Fall")) 
 
forage_std$CompVar <- factor(forage_std$CompVar,levels = c("Spring",
                                                    "Fall"))

# compare them

survforage_comp <- survforage %>%
  tidyr::separate(Var, c(NA, "Season"), sep = " ") %>%
  dplyr::select(Time, Season, EPU, stdsurvForage, stdsurvForageupper, stdsurvForagelower) %>%
  dplyr::mutate(Time = as.integer(Time))

compareforageagg <- forage_std %>%
  tidyr::separate(Var, c(NA, "Season"), sep = " ") %>%
  dplyr::select(Time, Season, EPU, stdForage, stdForageupper, stdForagelower) %>%
  left_join(survforage_comp) 

ggplot2::ggplot(compareforageagg, aes(x=stdForage, y=stdsurvForage)) +
  geom_point(color="blue", alpha=0.1)+
  geom_abline(intercept = 0, slope = 1, lty=3) +
  geom_smooth(method=lm) +
  stat_cor(method="pearson") +
  ecodata::theme_facet() +
  facet_grid(fct_relevel(EPU,  "GOM", "GB", "MAB")~
               fct_relevel(Season, "Spring", "Fall")) 
  
```
```{r}

#  unique(forageindex$SCINAME)
#  [1] ENGRAULIDAE           LOLIGO PLEI           CLUPEA HARENGUS       SCOMBER SCOMBRUS     
#  [5] ANCHOA MITCHILLI      POMATOMUS SALTATRIX   PEPRILUS TRIACANTHUS  PLEURONECTIFORMES    
#  [9] MERLUCCIUS            PEPRILUS              CLUPEIDAE             AMMODYTES            
# [13] LOLIGO PEALEII        BREVOORTIA            ETRUMEUS TERES        STENOTOMUS CHRYSOPS  
# [17] ENGRAULIS EURYSTOLE   MERLUCCIUS BILINEARIS CEPHALOPODA           ANCHOA HEPSETUS      
# [21] CYNOSCION REGALIS     AMMODYTES AMERICANUS  AMMODYTES DUBIUS      ILLEX ILLECEBROSUS

#  unique(blueprey$pynam)
#  [1] "LOLIGO SP"             "ENGRAULIDAE"           "ANCHOA MITCHILLI"      "PEPRILUS TRIACANTHUS" 
#  [5] "CEPHALOPODA"           "ANCHOA HEPSETUS"       "ETRUMEUS TERES"        "AMMODYTES SP"         
#  [9] "STENOTOMUS CHRYSOPS"   "MERLUCCIUS BILINEARIS" "ILLEX SP"              "CLUPEA HARENGUS"      
# [13] "CLUPEIDAE"             "POMATOMUS SALTATRIX"   "ENGRAULIS EURYSTOLE"   "LOLIGO PEALEII"       
# [17] "SCOMBER SCOMBRUS"      "PLEURONECTIFORMES"     "CYNOSCION REGALIS"     "BREVOORTIA TYRANNUS"  

# colors from http://medialab.github.io/iwanthue/ 12 hard(Force vector) colorblind friendly full range H C L
# sorted by diff

# unmanaged "#890058",
# managed "#afe5ff"

sandlances <- data.frame(prey=c("AMMODYTES",
                                "AMMODYTES SP",
                                "AMMODYTES AMERICANUS",  
                                "AMMODYTES DUBIUS"),
                         preycol=c("#3b0062",
                                   "#3b0062",
                                   "#3b0062",
                                   "#3b0062"),
                         mgtcol=c("#890058",
                                  "#890058",
                                  "#890058",
                                  "#890058"))
  
anchovies <- data.frame(prey=c("ENGRAULIDAE", 
                               "ANCHOA MITCHILLI",
                               "ANCHOA HEPSETUS",
                               "ENGRAULIS EURYSTOLE"),
                         preycol=c("#004d15",
                                   "#004d15",
                                   "#004d15",
                                   "#004d15"),
                         mgtcol=c("#890058",
                                  "#890058",
                                  "#890058",
                                  "#890058"))  
  
herrings <- data.frame(prey=c("CLUPEA HARENGUS",
                              "CLUPEIDAE",
                              "ETRUMEUS TERES"),
                         preycol=c("#ff3c98",
                                   "#ff3c98",
                                   "#ff3c98"),
                         mgtcol=c("#afe5ff",
                                  "#afe5ff",
                                  "#890058")) 
  
squids <- data.frame(prey=c("LOLIGO SP",
                            "LOLIGO PLEI",
                            "LOLIGO PEALEII",
                            "ILLEX SP",
                            "ILLEX ILLECEBROSUS",
                            "CEPHALOPODA"),
                         preycol=c("#a9f2ff",
                                   "#a9f2ff",
                                   "#a9f2ff",
                                   "#a9f2ff",
                                   "#a9f2ff",
                                   "#a9f2ff"),
                         mgtcol=c("#afe5ff",
                                  "#890058",
                                  "#afe5ff",
                                  "#afe5ff",
                                  "#afe5ff",
                                  "#890058")) 
  
silverhake <- data.frame(prey=c("MERLUCCIUS",
                                "MERLUCCIUS BILINEARIS"),
                         preycol=c("#be5000",
                                   "#be5000"),
                         mgtcol=c("#afe5ff",
                                  "#afe5ff"))

butterfish <- data.frame(prey=c("PEPRILUS",
                                "PEPRILUS TRIACANTHUS"),
                         preycol=c("#d6b8ff",
                                   "#d6b8ff"),
                         mgtcol=c("#afe5ff",
                                  "#afe5ff"))

bluefish <- data.frame(prey=c("POMATOMUS SALTATRIX"),
                         preycol=c("#2eff7d"),
                         mgtcol=c("#afe5ff"))

mackerel <- data.frame(prey=c("SCOMBER SCOMBRUS"),
                         preycol=c("#ffb4b5"),
                         mgtcol=c("#afe5ff"))

scup <- data.frame(prey=c("STENOTOMUS CHRYSOPS"),
                         preycol=c("#1810b8"),
                         mgtcol=c("#afe5ff"))

weakfish <- data.frame(prey=c("CYNOSCION REGALIS"),
                         preycol=c("#759700"),
                         mgtcol=c("#afe5ff"))

menhaden <- data.frame(prey=c("BREVOORTIA",
                              "BREVOORTIA TYRANNUS"),
                         preycol=c("#547aff",
                                   "#547aff"),
                         mgtcol=c("#afe5ff",
                                  "#afe5ff"))

otherflats <- data.frame(prey = c("PLEURONECTIFORMES"),
                         preycol=c("#48beff"),
                         mgtcol=c("#890058"))

preycolcode <- rbind(sandlances,
                     anchovies,
                     herrings,
                     squids,
                     silverhake,
                     butterfish,
                     bluefish,
                     mackerel,
                     scup,
                     weakfish,
                     menhaden,
                     otherflats)

preycols <- preycolcode$preycol
names(preycols) <- as.factor(preycolcode$prey)

mgtcols <- preycolcode$mgtcol
names(mgtcols) <- as.factor(preycolcode$prey)

```


Dominant species in diet based index. species comp (raw)

```{r dietspp}

bluepyall_stn <- readRDS(here("fhdat/bluepyall_stn.rds"))

 MAB <- data.frame(stratum = c(1010:1080, 1100:1120, 1600:1750, 3010:3450, 3470, 3500, 3510),
                      EPU = "MAB")
 
 GB <- data.frame(stratum = c(1090, 1130:1210, 1230, 1250, 3460, 3480, 3490, 3520:3550),
                  EPU = "GB")
 
 GOM <- data.frame(stratum = c(1220, 1240, 1260:1290, 1360:1400, 3560:3830),
                   EPU = "GOM")
  
EPUlook <- dplyr::bind_rows(MAB, GB, GOM)

foragesppwt <- bluepyall_stn %>%
  dplyr::left_join(EPUlook) %>%
  dplyr::filter(blueprey=="blueprey",
                !is.na(EPU)) %>%
  dplyr::group_by(year, season_ng, EPU, bluepynam) %>%
  dplyr::summarise(pysum = sum(bluepywt))

plotDietCompBar <- function(dat, metric, plotcol, title=NULL){   #defines the name of the function and the requied inputs
  
dat %>% 
  filter(!is.na(.data[[metric]])) %>%          #take out the NA values (literally "not is NA")
  ggplot(aes(x=year, y=.data[[metric]], fill=bluepynam)) +     #year on x axis, %diet comp on y
  geom_bar(width = 1, stat = "identity", position="fill") +    #stacked bar chart
  scale_fill_manual(values=plotcol) +         #custom colors
  ecodata::theme_facet() +                    #simplify
  facet_grid(fct_relevel(EPU,  "GOM", "GB", "MAB")~
               fct_relevel(season_ng, "SPRING", "FALL")) + #separate by ordered epu and season
  labs(y = "% composition",              #add sensible labels
       title = title) 
    
}   

addSmallLegend <- function(myPlot, pointSize = 2, textSize = 6, spaceLegend = 0.5) {
    myPlot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize)),
               fill = guide_legend(ncol = 1)) +
        theme(legend.title = element_text(size = textSize), 
              legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}

pall <- plotDietCompBar(dat=foragesppwt, 
                          metric="pysum", 
                        plotcol=preycols,
                          title="Diet composition")  

addSmallLegend(pall)

```

Dominant species in survey forage index

```{r surveyspp}

load(here("survdat/Survdat.Rdata")) # from repo above, can't pull directly

pulldate <- survey$pullDate
functioncall <- survey$functionCall
survdat <- survey$survdat

#Aggregate species----
#Grab species list
#load(here('data_raw/SOE_species_list.RData'))

# see https://stackoverflow.com/questions/32914357/dplyr-inner-join-with-a-partial-string-match
# https://stackoverflow.com/questions/60993676/join-data-frames-based-fuzzy-matching-of-strings

library(fuzzyjoin)

bluepreyonly <- blueprey %>%
  dplyr::select(pynam)

my_match_fun <- Vectorize(function(x,y) agrepl(x, y, ignore.case=TRUE))#, max.distance = 0.12, useBytes = TRUE))

foragelist <- ecodata::species_groupings %>%
  mutate(charsciname = as.character(SCINAME)) %>%
  #regex_inner_join(blueprey, by = c(charsciname = "pynam"))
  #fuzzy_inner_join(blueprey, by = c(charsciname = "pynam"), match_fun = str_detect)
  fuzzy_inner_join(bluepreyonly, by = c(charsciname = "pynam"), match_fun = my_match_fun)

# missing specific sandlances, I want all three of these
sandlances <- ecodata::species_groupings %>% filter(str_detect(SCINAME, "AMMO"))

# missing Illex
illex <- ecodata::species_groupings %>% filter(str_detect(SCINAME, "ILLEX"),
                                               !str_detect(SCINAME, "EGG"))

forageindex <- foragelist %>%
  dplyr::select(-charsciname, -pynam) %>%
  bind_rows(sandlances, illex) %>%
  distinct() %>%
  mutate(ForageIndex = "ForageIndex")

species_groupings_forage <- ecodata::species_groupings %>%
  left_join(forageindex)

species <- as.data.table(species_groupings_forage)

#Merge to get species group and fed managed status
survdat <- merge(survdat, unique(species[, list(SVSPP, SCINAME, ForageIndex)]), 
                 by = 'SVSPP', all.x = T)

foragesurv <- survdat %>%
  tibble::as.tibble() %>%
  dplyr::rename_with(tolower, .cols = everything()) %>%
  dplyr::mutate(stratum = as.integer(stratum)) %>%
  dplyr::left_join(EPUlook) %>%
  dplyr::filter(!is.na(forageindex),
                !is.na(EPU)) %>%
  dplyr::group_by(year, season, EPU, sciname) %>%
  dplyr::summarise(pysum = sum(biomass)) %>%
  dplyr::rename(season_ng = season, bluepynam = sciname)

psurv <- plotDietCompBar(dat=foragesurv, 
                          metric="pysum", 
                          plotcol=preycols,
                          title="Survey composition")  

addSmallLegend(psurv)

```
  
As hypothesized, silver hake dominate GOM spring in both datasets. The indices are highly correlated when the species composition is similar for the Gulf of Maine in spring, suggesting that the diet based index is at least as reliable as a survey biomass based index, given similar inputs. 

Managed (light blue) or unmanaged (burgundy): Diet based forage

```{r}

pall <- plotDietCompBar(dat=foragesppwt, 
                          metric="pysum", 
                        plotcol=mgtcols,
                          title="Diet composition")  

addSmallLegend(pall)
```


Managed (light blue) or unmanaged (burgundy): Survey based forage

```{r}

psurv <- plotDietCompBar(dat=foragesurv, 
                          metric="pysum", 
                          plotcol=mgtcols,
                          title="Survey composition")  

addSmallLegend(psurv)
```

We see a higher proportion of unmanaged forage species in the diet based raw data than we do the survey based raw data, suggesting that the diet-based forage index better represents species the survey is not designed to sample directly. 

# Discussion

Bluefish are generalist predators. Understanding how bluefish availability may be affected by their prey field means looking across many potential prey species, including species not well sampled by bottom trawl surveys. We characterized aggregate forage fish trends using piscivore stomach data as input observations to a vector autoregressive spatio-temporal (VAST) model. The resulting model-derived forage indices suggest that aggregate forage fish biomass has fluctuated in both space and time in the Northeast US, especially in areas relevant to the bluefish assessment. Evaluating these indices within the bluefish assessment model as covariates reflecting bluefish availability to fisheries and surveys is in progress.

Although time series of aggregate forage biomass for direct comparison with this work are lacking, we think, due to good sample sizes and VAST model diagnostics, that this is the best representation we have of aggregate forage fish trends in this region. Fish stomach data has been used to index prey abundance, especially for data-poor prey taxa poorly sampled by bottom trawls, in multiple ecosystems worldwide [@fahrig_predator_1993; @link_using_2004; @mills_diets_2007; @cook_use_2012; @lasley-rasher_it_2015; @rohan_spatial_2017; @sydeman_integrating_2022]. Integrating fish stomach content information within a VAST model to index prey biomass was shown to be successful with selected predators of Atlantic herring in the Northeast US [@ng_predator_2021], using a subset of the data we used here. In particular, reasonable agreement was found between the Atlantic cod diet-derived Atlantic herring biomass index and Atlantic herring assessment biomass trends. However, herring indices based on stomach contents from other individual predators (e.g., silver hake) had poor agreement with herring assessment trends [@ng_predator_2021]. @ng_predator_2021 noted that decadal trends generally agreed across predators between diet-based and stock assessment Atlantic herring biomass indices, but that shorter term trends varied considerably by seasons and predators. Further, changes in spatial overlap between individual predators and prey over time was noted by @ng_predator_2021 as a potential issue with using diet-based indices of Atlantic herring abundance. 

Aggregation of predators and seasons was one recommendation for future work from @ng_predator_2021 to address some of the issues with using predator stomach data to evaluate prey biomass. Our approach combining stomach data across multiple piscivore predators was intended to improve sample size for the aggregate prey index so that our results integrate across individual predator sampling variability and changes in predator-prey overlap, and perhaps clarify the longer term, decadal trends in forage fish biomass. Further, evaluating forage species in aggregate should also reduce issues of changing overlap of predators with individual prey species. However, we don't have an aggregate forage fish assessment time series for comparison. Using survey biomass catch of forage fish directly can be problematic, including issues with poor sample size or missing data for key small pelagic fish (anchovies, sandlance) and cephalopods [@mills_diets_2007; @rohan_spatial_2017]. In comparing compositions of diet based and survey based forage species indices, there was a clear dominance of larger managed species in the survey based index. Further, bottom trawl survey biomass time series for assessed forage species can be at odds with other assessment inputs and assessment-estimated biomass trends in the Northeast US. For example, Atlantic mackerel bottom trawl survey indices have generally increased while assessment estimated biomass, largely driven by an egg survey and information on catch, is decreasing [@nefsc_64th_2018]. Therefore, our forage index represents an alternative, possibly more complete assessment of aggregate forage fish in this region than can be obtained directly from bottom trawl surveys. 

Changes in forage fish are of interest across seasons, but changes in the fall index nearshore may be most closely aligned with abundance indices used in the bluefish assessment. Bluefish migrate into northern coastal waters in spring and return south in late fall to overwinter [@collette_bigelow_2002]. Although bluefish catch patterns vary by state, recreational fishing dominates coastwide bluefish landings, and most recreational fishing activity (nearly 70% of landings) takes place in July-October (2022 bluefish research track summary report), months included in the fall forage index (months 7-12). Further, northern states, included in the spatial extent of the forage index, see peak recreational fishing during these months. Therefore, our fall forage indices may provide a reasonable match to the recreational catch per unit effort index used in the assessment. Similarly, fall forage indices for fishery independent survey strata also temporally and spatially align with both the fall NEFSC bottom trawl survey and fall NEAMAP bottom trawl survey stratified mean catch-per-tow used in the bluefish assessment (2022 bluefish research track summary report).

[*Paragraph on preliminary results of including the index in companion model: starting point text from presentation*

Forage fish indices were explored as covariates on catchability for the fishery independent bottom trawl surveys, but either did not improve the assessment, or the exploratory models did not converge. However, the application of the forage fish index to the recreational catch per angler catchability was successful when implemented as an autoregressive process over the time-series with WHAM estimating the standard error.  The inclusion of the forage fish index improved the fit of all models. The use of the forage fish index as a covariate on catchability led to an overall decreasing trend in catchability over time.  The recreational index is important in scaling the biomass results, and the lower availability at the end of the time-series led to higher biomass estimates from the assessment including forage fish.

]

While the fall forage fish indices are temporally aligned with bluefish assessment inputs and spatially aligned with two trawl survey indices used in the assessment, improvements in spatial overlap with recreational fisheries and other survey indices could be considered in the future. A large proportion (51\%) of bluefish recreational landings come from inland waters: bays and estuaries including Chesapeake Bay, Delaware Bay, and Long Island Sound, with the next largest proportion (42\%) coming from state waters extending 3 nautical miles from the coastline (2022 bluefish research track summary report). The current forage index does not cover inland waters, aside from Narragansett Bay and Buzzards Bay. Diet data are available for Chesapeake Bay from the ChesMMAP survey, which could be added to the VAST model in the future. Less diet information is available for the portion of the bluefish range south of Cape Hatteras, although some collections have taken place. Investigation of sources of diet information, or possibly direct forage fish surveys for inland and southern areas would be worthwhile to see whether data are adequate to cover the full range of bluefish. In addition, it is worth exploring whether including indices as area-expanded estimates or as unexpanded forage density in each area of interest provides more information to the bluefish assessment model.

The general method of using stomach information to estimate prey indices can be extended to address other predators with different prey fields (e.g., benthic feeders; @link_using_2004; @lasley-rasher_it_2015; @rohan_spatial_2017) or different spatial distributions. Further adjustments to the VAST model could explore the sensitivity of aggregate forage trends to the inclusion or exclusion of predators from diet sampling over time and the level of species identification in diets. For example, we aggregated predators most similar to bluefish based on analysis of the full diet database to minimize impacts from uneven sampling of individual predators, but some differences in predator sampling over time (e.g. squid stomachs sampled up to 2000s, not thereafter) may still affect the forage index. More importantly, we had to leave out the "fish unidentified" prey category which comprised 25-30% of bluefish diet because while these prey may be forage fish for bluefish, there is no guarantee they would be for other sampled predators we included in the model. Increased use of a broad "fish unidentified" category would degrade the use of this index in the future, so continued investment in high quality stomach data collection is crucial. In addition, including more information on the process of fish predation (which we somewhat controlled for as catchability covariates for number of predators, predator size, and temperature) may help to refine aggregate forage indices. For example, in this initial model we have not accounted for functional responses of predators, but new research may allow us to do so in future iterations [@smith_multispecies_2020; @robertson_accounting_2022]. 

Overall, this index provides insight into temporal and spatial variation at the forage fish community level, which is important both for individual predators and for ecosystem assessment. Forage fish link lower trophic level productivity with larger fish important for human consumption and recreation as well as for protected species, so understanding aggregate forage dynamics within an ecosystem may support analysis related to management for multiple living resources [@smith_impacts_2011; @essington_fishing_2015; @punt_exploring_2016; @levin_thirty-two_2016; @tommasi_improved_2017; @soudijn_harvesting_2021]. While aggregate indices of forage fish may be inherently more stable than individual forage species population trajectories, we still find substantial fluctuations in this forage index. Investigation into drivers of forage fish (and predator) spatial and temporal shifts demonstrate substantial variability. Many factors influence forage distribution and abundance, including environmental drivers changing habitat and impacting species differently, resulting in often unclear or mixed signals across taxa, although general trends in the Northeast US are towards the northeast and into deeper water [@fredston_range_2021; @suca_environmental_2021]. This initial aggregate forage index provides the opportunity to investigate whether temporal and spatial trends are coherent with aggregate zooplankton indices and or spatial and temporal patterns in environmental drivers. Ongoing analyses of ecosystem linkages with the forage index may provide insight both for improving the index for future predator stock assessments and for ecosystem reporting in the Northeast US [@nefsc_2022_2022].


# References
